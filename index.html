<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Advisory Sales Assistant - Call One Discovery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- LEFT SIDEBAR: Sequential Track -->
        <nav class="sidebar-left">
            <div class="sidebar-header">
                <h1>ğŸ“ CALL ONE FLOW</h1>
                <p>Revenue Discovery Script</p>
            </div>

            <!-- MAIN CALL FLOW -->
            <div class="nav-section collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">1. Opening</div>
                <div id="phase1-nav" class="nav-content"></div>
            </div>

            <div class="nav-section collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">2. Qualification</div>
                <div id="phase2-nav" class="nav-content"></div>
            </div>

            <div class="nav-section collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">3. Discovery</div>
                <div id="phase3-nav" class="nav-content"></div>
            </div>

            <div class="nav-section collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">4. Deployment</div>
                <div id="phase3df-nav" class="nav-content"></div>
            </div>

            <div class="nav-section collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">5. Close</div>
                <div id="phase45-nav" class="nav-content"></div>
            </div>

            <!-- REFERENCE LIBRARY -->
            <div class="nav-section nav-section-reference collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">ğŸ“š Library</div>
                <div id="reference-nav" class="nav-content"></div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="content-wrapper">
                <div id="content-area">
                    <!-- Welcome screen initially -->
                    <div class="welcome-screen">
                        <h2>Revenue Advisory Sales Assistant</h2>
                        <p>Navigate through the Call One Discovery process. Use the left sidebar for sequential flow, right sidebar for objection handlers.</p>
                        <a href="#" class="welcome-cta" onclick="loadContent('opening_frame'); return false;">Start Call One â†’</a>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR: Handler Library -->
        <nav class="sidebar-right">
            <div class="sidebar-header">
                <h1>â›½ HANDLER LIBRARY</h1>
                <p>Pull off, handle, return</p>
            </div>

            <div class="nav-section collapsed">
                <div class="nav-section-title" onclick="togglePhase(this)">â­ Top Objections</div>
                <div class="interrupt-sequence nav-content">
                    <div class="interrupt-step" onclick="loadContent('pricing_objection')">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Pricing Objection</div>
                            <div class="step-desc">Handle early pricing questions</div>
                        </div>
                    </div>
                    <div class="interrupt-step" onclick="loadContent('universal_objection_handle')">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Universal Handle</div>
                            <div class="step-desc">Framework for any objection</div>
                        </div>
                    </div>
                    <div class="interrupt-step" onclick="loadContent('referrals_objection')">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Referrals Objection</div>
                            <div class="step-desc">Handle referral-only prospects</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ğŸ” Search Handlers</div>
                <div class="search-container">
                    <input type="text" id="handler-search" placeholder="Search objections by keyword..." onkeyup="filterHandlers(); toggleClearButton()" oninput="toggleClearButton()">
                    <button type="button" id="clear-search" class="clear-search-btn" onclick="clearSearch()" title="Clear search" style="display: none;">Ã—</button>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">â›½ FULL HANDLER LIBRARY</div>
                <div id="handler-nav"></div>
            </div>
        </nav>
    </div>

        <!-- MOBILE SIDEBAR OVERLAY -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebars()"></div>

        <!-- SETTINGS POPUP -->
        <div class="settings-popup" id="settings-popup">
            <div class="settings-content">
                <div class="settings-controls">
                    <div class="control-group control-group-color-theme">
                        <label class="control-label">Color Scheme</label>
                        <select id="theme-select" class="theme-select">
                            <option value="ocean-light">ğŸŒŠ Ocean Light</option>
                            <option value="ocean-dark">ğŸŒŠ Ocean Dark</option>
                            <option value="forest-light">ğŸŒ² Forest Light</option>
                            <option value="forest-dark">ğŸŒ² Forest Dark</option>
                            <option value="sunset-light">ğŸŒ… Sunset Light</option>
                            <option value="sunset-dark">ğŸŒ… Sunset Dark</option>
                            <option value="lavender-light">ğŸ’œ Lavender Light</option>
                            <option value="lavender-dark">ğŸ’œ Lavender Dark</option>
                            <option value="neutral-light">âšª Neutral Light</option>
                            <option value="neutral-dark">âš« Neutral Dark</option>
                            <option value="rose-light">ğŸŒ¸ Rose Light</option>
                            <option value="rose-dark">ğŸŒ¸ Rose Dark</option>
                            <option value="sage-light">ğŸŒ¿ Sage Light</option>
                            <option value="sage-dark">ğŸŒ¿ Sage Dark</option>
                            <option value="sky-light">â˜ï¸ Sky Light</option>
                            <option value="sky-dark">â˜ï¸ Sky Dark</option>
                            <option value="orange-light">ğŸ§¡ Orange Light</option>
                            <option value="orange-dark">ğŸ§¡ Orange Dark</option>
                            <option value="presentation-light">ğŸ’¼ Presentation Light</option>
                            <option value="presentation-dark">ğŸ’¼ Presentation Dark</option>
                        </select>
                    </div>

                    <div class="control-group control-group-font">
                        <label class="control-label">Font</label>
                        <select id="font-select" class="font-select">
                            <option value="Merriweather">Merriweather</option>
                            <option value="Inter">Inter</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Lato">Lato</option>
                            <option value="Spectral">Spectral</option>
                            <option value="Atkinson Hyperlegible">Atkinson Hyperlegible</option>
                        </select>
                    </div>

                    <div class="control-group control-group-size">
                        <label class="control-label">Font Size</label>
                        <div class="font-size-controls">
                            <button class="control-btn" id="size-decrease" title="Decrease Font Size">âˆ’</button>
                            <span class="font-size-display" id="font-size-value">16px</span>
                            <button class="control-btn" id="size-increase" title="Increase Font Size">+</button>
                        </div>
                    </div>

                    <div class="control-group control-group-reset">
                        <label class="control-label">Question Progress</label>
                        <button class="control-btn reset-btn" id="reset-questions" title="Reset All Question Checkmarks" onclick="resetAllQuestions()">ğŸ”„ Reset Questions</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- SETTINGS BUTTON -->
    <button class="settings-fab" id="settings-fab" title="Settings">
        âš™ï¸
    </button>
    
    <!-- ADVICE TOGGLE BUTTON -->
    <button class="advice-toggle-fab" id="advice-toggle-fab" title="Toggle Advice">
        ğŸ’¡
    </button>

    <script src="sales_script.js"></script>

    <!-- Question toggle functionality -->
    <script>
        function toggleQuestion(questionId, element) {
            const currentState = localStorage.getItem(`question_${questionId}`) === 'true';
            const newState = !currentState;

            // Save to localStorage
            localStorage.setItem(`question_${questionId}`, newState.toString());

            // Update visual styling
            if (newState) {
                element.classList.add('asked');
            } else {
                element.classList.remove('asked');
            }
        }

        function resetAllQuestions() {
            // Clear all question states from localStorage
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('question_')) {
                    localStorage.removeItem(key);
                }
            });

            // Remove styling from all question items
            const questionItems = document.querySelectorAll('.question-item');
            questionItems.forEach(item => {
                item.classList.remove('asked');
            });

            // Show confirmation
            alert('All question progress has been reset.');
        }
    </script>

    <!-- Navigation functions moved to sales_script.js -->
    <script>
        function togglePhase(element) {
            const navSection = element.parentElement;
            navSection.classList.toggle('collapsed');
        }

        function toggleQuestionGroup(element) {
            const questionGroup = element.parentElement;
            questionGroup.classList.toggle('collapsed');
        }

        function buildNavigation() {
            // Define phase navigation mappings
            const phaseNavs = {
                1: 'phase1-nav',
                2: 'phase2-nav',
                3: 'phase3-nav',
                4: 'phase3df-nav', // Tic-Tac-Toe items
                5: 'phase45-nav'
            };
            
            // Group items by phase
            const phaseGroups = {};
            salesData.sequential_flow.call_one.forEach(item => {
                let phase = item.phase;

                // Interrupt items are handled in the right sidebar handler library, not here
                // if (item.category === 'interrupt') {
                //     phase = 3;
                // }

                // Special handling for QOA deployment items
                if (item.id && (item.id.includes('qoa') || item.id.includes('tic') || item.id.includes('tac') || item.id.includes('toe'))) {
                    phase = 4; // QOA Deployment phase
                }

                if (!phaseGroups[phase]) phaseGroups[phase] = [];
                phaseGroups[phase].push(item);
            });
            
            // Render each phase section
            Object.entries(phaseNavs).forEach(([phase, navId]) => {
                const navElement = document.getElementById(navId);
                if (!navElement) return;

                const items = phaseGroups[phase] || [];
                items.forEach((item, index) => {
                    // Skip items without required properties
                    if (!item.id || !item.title) return;

                    const navItem = document.createElement('div');
                    navItem.className = 'nav-item';
                    navItem.setAttribute('data-id', item.id);
                    navItem.onclick = () => loadContent(item.id);

                    // Determine icon
                    let icon = 'ğŸ“„';
                    if (item.category === 'interrupt') icon = 'âš ï¸';
                    else if (item.id === 'opening_frame') icon = 'ğŸ¬';
                    else if (item.id === 'fork_deflection') icon = 'ğŸ”€';
                    else if (item.id === 'discovery_intro') icon = 'ğŸ¯';
                    else if (item.id === 'discovery_top_funnel') icon = 'â¬†ï¸';
                    else if (item.id === 'discovery_middle_funnel') icon = 'âš™ï¸';
                    else if (item.id === 'discovery_bottom_funnel') icon = 'ğŸ’°';
                    else if (item.id === 'qoa_deployment_guide') icon = 'âš“';
                    else if (item.id === 'integration_explanation') icon = 'ğŸ”—';
                    else if (item.id === 'transition_call_two') icon = 'ğŸ“…';

                    // Add page numbering (phase.page)
                    const pageNumber = `${phase}.${index + 1}`;

                    navItem.innerHTML = `
                        <span class="nav-item-number">${pageNumber}</span>
                        <span class="nav-item-icon">${icon}</span>
                        <span style="flex: 1;">${item.title.split('â€”')[0].trim()}</span>
                    `;
                    navElement.appendChild(navItem);
                });
            });
        }

        function buildReferenceNavigation() {
            const referenceNav = document.getElementById('reference-nav');

            // Reference libraries available
            const referenceLibraries = [
                { id: 'two_economies', title: 'Understanding The Two Economies', icon: 'ğŸ¢' },
                { id: 'carpet_framework', title: 'CARPET Framework', icon: 'ğŸ§¹' },
                { id: 'discovery_framework', title: 'Discovery Framework', icon: 'ğŸ”' },
                { id: 'active_listening', title: 'Active Listening', icon: 'ğŸ‘‚' },
                { id: 'qualified_opportunity_anchor_mastery', title: 'QOAâ„¢ Complete Training Guide', icon: 'âš“' },
                { id: 'discovery_objection_handling_os', title: 'Discovery Objection Handling OS', icon: 'ğŸ›¡ï¸' },
                { id: 'referrals_objection_mastery', title: 'Referrals Objection Mastery', icon: 'ğŸ”—' }
            ];

            referenceLibraries.forEach(library => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.setAttribute('data-id', library.id);
                navItem.onclick = () => loadReferenceContent(library.id);

                navItem.innerHTML = `
                    <span class="nav-item-icon">${library.icon}</span>
                    <span style="flex: 1;">${library.title}</span>
                `;
                referenceNav.appendChild(navItem);
            });
        }

        function buildHandlerNavigation() {
            const handlerNav = document.getElementById('handler-nav');

            // TEMP: Skip data check for testing
            console.log('Building handler navigation...');

            // Handler categories as specified in the interface
            const handlerCategories = [
                {
                    title: "ğŸ­ Stories (9)",
                    count: 8,
                    handlers: [
                        { id: 'different_from_other_industries', title: 'ğŸ­ No Industry Experience' },
                        { id: 'past_vendor_failure', title: 'ğŸš« Past Vendor Failures' },
                        { id: 'entity_size_credibility', title: 'ğŸ“ Entity Size/Credibility' },
                        { id: 'guarantees', title: 'ğŸ›¡ï¸ Guarantees/Proof' },
                        { id: 'brand_risk_spam', title: 'ğŸš¨ Brand Risk/Spam' },
                        { id: 'what_makes_you_different', title: 'â­ What Makes You Different?' },
                        { id: 'internal_team_exists', title: 'ğŸ‘¥ Internal Team Exists' }
                    ]
                },
                {
                    title: "ğŸ¬ Opening Frame (6)",
                    count: 6,
                    handlers: [
                        { id: 'just_email_me_info', title: 'ğŸ“§ Just Email Me Info' },
                        { id: 'research_mode', title: 'ğŸ” Research Mode' },
                        { id: 'not_interested', title: 'ğŸ™… Not Interested' },
                        { id: 'what_makes_you_different', title: 'â­ What Makes You Different?' },
                        { id: 'who_else_worked_with', title: 'ğŸ¤ Who Else Worked With' },
                        { id: 'calling_other_people', title: 'ğŸ“ Calling Other People' }
                    ]
                },
                {
                    title: "ğŸ”€ Fork Deflection (6)",
                    count: 6,
                    handlers: [
                        { id: 'still_confused', title: 'ğŸ˜µ Still Confused' },
                        { id: 'too_much_information', title: 'ğŸ“š Too Much Information' },
                        { id: 'want_something_in_writing', title: 'ğŸ“ Want Something in Writing' },
                        { id: 'case_study_request_mid_explanation', title: 'ğŸ“– Case Study Request Mid-Explanation' },
                        { id: 'doesnt_sound_like_what_we_need', title: 'âŒ Doesn\'t Sound Like What We Need' },
                        { id: 'different_from_other_industries', title: 'ğŸ­ Have You Worked In My Industry Before?' }
                    ]
                },
                {
                    title: "ğŸ’° Money & Budget (8)",
                    count: 8,
                    handlers: [
                        { id: 'discount_request', title: 'ğŸ’¸ Discount Request' },
                        { id: 'payment_terms', title: 'â° Payment Terms' },
                        { id: 'budget_constraints', title: 'ğŸ’µ Budget Constraints' },
                        { id: 'free_pilot', title: 'ğŸ†“ Free Pilot' },
                        { id: 'performance_only', title: 'ğŸ“ˆ Performance-Only' },
                        { id: 'roi_questions', title: 'ğŸ“Š ROI Questions' },
                        { id: 'cost_breakdown', title: 'ğŸ§® Cost Breakdown' },
                        { id: 'payment_plans', title: 'ğŸ“… Payment Plans' }
                    ]
                },
                {
                    title: "âš ï¸ Quality & Proof (12)",
                    count: 12,
                    handlers: [
                        { id: 'quality_concern_early', title: 'ğŸ” Quality Concern (Early)' },
                        { id: 'quality_concern_late', title: 'ğŸ¯ Quality Concern (Late)' },
                        { id: 'quality_concern_toe', title: 'âš“ Quality Concern (Requires Toe)' },
                        { id: 'case_studies', title: 'ğŸ“š Case Studies' },
                        { id: 'references', title: 'ğŸ‘¥ References' },
                        { id: 'proof_of_concept', title: 'ğŸ§ª Proof of Concept' },
                        { id: 'past_vendor_failure', title: 'ğŸš« Past Vendor Failure' },
                        { id: 'entity_size_credibility', title: 'ğŸ“ Entity Size/Credibility' },
                        { id: 'guarantees', title: 'ğŸ›¡ï¸ Guarantees' },
                        { id: 'will_they_convert', title: 'ğŸ“ˆ Will They Convert?' },
                        { id: 'define_qualified', title: 'ğŸ² Define Qualified' },
                        { id: 'verification_questions', title: 'âœ… Verification Questions' }
                    ]
                },
                {
                    title: "âš™ï¸ How & Mechanism (8)",
                    count: 8,
                    handlers: [
                        { id: 'how_do_you_do_it', title: 'ğŸ”§ How Do You Do It?' },
                        { id: 'what_tools', title: 'ğŸ› ï¸ What Tools?' },
                        { id: 'are_you_using_ai', title: 'ğŸ¤– Are You Using AI?' },
                        { id: 'do_you_buy_lists', title: 'ğŸ“‹ Do You Buy Lists?' },
                        { id: 'spam_filter_question', title: 'ğŸ›¡ï¸ Spam Filter Question' },
                        { id: 'channel_questions', title: 'ğŸ“¡ Channel Questions' },
                        { id: 'infrastructure_questions', title: 'ğŸ—ï¸ Infrastructure Questions' },
                    ]
                },
                {
                    title: "ğŸ”— Referrals & Connections (6)",
                    count: 6,
                    handlers: [
                        { id: 'do_you_have_connections', title: 'ğŸ¤ Do You Have Connections?' },
                        { id: 'we_only_do_referrals', title: 'ğŸ‘¥ We Only Do Referrals' },
                        { id: 'referral_purist', title: 'ğŸ¯ Referral Purist' },
                        { id: 'warm_intro_obsession', title: 'ğŸ”¥ Warm Intro Obsession' },
                        { id: 'network_questions', title: 'ğŸŒ Network Questions' },
                        { id: 'referrals_objection', title: 'ğŸ”— Referrals Objection' }
                    ]
                },
                {
                    title: "âš–ï¸ Competition (5)",
                    count: 5,
                    handlers: [
                        { id: 'talking_to_other_vendors', title: 'ğŸ¢ Talking to Other Vendors' },
                        { id: 'competitor_cheaper', title: 'ğŸ’° Competitor Cheaper' },
                        { id: 'competitor_guarantee', title: 'ğŸ›¡ï¸ Competitor Guarantee' },
                        { id: 'what_makes_you_different', title: 'â­ What Makes You Different?' },
                        { id: 'rfp_policy', title: 'ğŸ“„ RFP/3-Quote Policy' }
                    ]
                },
                {
                    title: "â° Timing & Process (8)",
                    count: 8,
                    handlers: [
                        { id: 'timing_isnt_right', title: 'â³ Timing Isn\'t Right' },
                        { id: 'q4_freeze', title: 'â„ï¸ Q4 Freeze' },
                        { id: 'budget_cycle', title: 'ğŸ’° Budget Cycle' },
                        { id: 'lets_revisit_later', title: 'ğŸ“… Let\'s Revisit Later' },
                        { id: 'need_more_time', title: 'ğŸ• Need More Time' },
                        { id: 'send_info_first', title: 'ğŸ“§ Send Info First' },
                        { id: 'call_length_question', title: 'ğŸ“ Call Length Question' },
                        { id: 'can_we_make_this_quick', title: 'âš¡ Can We Make This Quick?' }
                    ]
                },
                {
                    title: "ğŸ‘¥ Internal Dynamics (10)",
                    count: 10,
                    handlers: [
                        { id: 'need_partner_approval', title: 'ğŸ¤ Need Partner Approval' },
                        { id: 'talk_to_team', title: 'ğŸ‘¥ Talk to Team' },
                        { id: 'board_approval', title: 'ğŸ›ï¸ Board Approval' },
                        { id: 'legal_review', title: 'âš–ï¸ Legal Review' },
                        { id: 'internal_team_exists', title: 'ğŸ¢ Internal Team Exists' },
                        { id: 'champion_departure', title: 'ğŸš¶ Champion Departure' },
                        { id: 'decision_path_questions', title: 'ğŸ—ºï¸ Decision Path Questions' },
                        { id: 'who_needs_to_see_this', title: 'ğŸ‘€ Who Needs to See This?' },
                        { id: 'procurement_process', title: 'ğŸ“‹ Procurement Process' },
                        { id: 'we_have_an_rfp', title: 'ğŸ“„ We Have an RFP' }
                    ]
                },
                {
                    title: "ğŸ“Š Process & Clarity (12)",
                    count: 12,
                    handlers: [
                        { id: 'vague_responses', title: 'ğŸ’­ Vague Responses' },
                        { id: 'dont_have_data', title: 'ğŸ“Š Don\'t Have Data' },
                        { id: 'need_to_check', title: 'ğŸ” Need to Check' },
                        { id: 'dont_track_formally', title: 'ğŸ“ˆ Don\'t Track Formally' },
                        { id: 'cant_answer', title: 'ğŸ¤· Can\'t Answer' },
                        { id: 'deflects_question', title: 'ğŸŒ€ Deflects Question' },
                        { id: 'too_many_questions', title: 'â“ Too Many Questions' },
                        { id: 'why_does_this_matter', title: 'ğŸ¤” Why Does This Matter?' },
                        { id: 'confidential_info', title: 'ğŸ”’ Confidential Info' },
                        { id: 'process_is_broken', title: 'ğŸ”§ Process is Broken' },
                        { id: 'were_rebuilding', title: 'ğŸ—ï¸ We\'re Rebuilding' },
                        { id: 'no_crm_tracking', title: 'ğŸš« No CRM/Tracking' }
                    ]
                },
                {
                    title: "ğŸ¯ Scope & Structure (11)",
                    count: 11,
                    handlers: [
                        { id: 'can_we_start_smaller', title: 'ğŸªœ Can We Start Smaller?' },
                        { id: 'pilot_request', title: 'ğŸ§ª Pilot Request' },
                        { id: 'scope_reduction', title: 'ğŸ“‰ Scope Reduction' },
                        { id: 'phased_rollout', title: 'ğŸ“… Phased Rollout' },
                        { id: 'one_market_first', title: 'ğŸŒ One Market First' },
                        { id: 'market_too_niche', title: 'ğŸ¯ Market Too Niche' },
                        { id: 'geographic_constraints', title: 'ğŸ—ºï¸ Geographic Constraints' },
                        { id: 'title_requirements', title: 'ğŸ‘¤ Title Requirements' },
                        { id: 'capacity_concerns', title: 'âš–ï¸ Capacity Concerns' },
                        { id: 'service_limitations', title: 'ğŸš« Service Limitations' },
                        { id: 'free_vs_paid_pilot', title: 'ğŸ’° Free vs Paid Pilot' }
                    ]
                },
                {
                    title: "ğŸ“‹ Contract & Legal (8)",
                    count: 8,
                    handlers: [
                        { id: 'contract_terms', title: 'ğŸ“„ Contract Terms' },
                        { id: 'cancellation_policy', title: 'âŒ Cancellation Policy' },
                        { id: 'what_happens_after_90', title: 'â° What Happens After 90?' },
                        { id: 'ip_ownership', title: 'ğŸ’¡ IP Ownership' },
                        { id: 'data_ownership', title: 'ğŸ’¾ Data Ownership' },
                        { id: 'nda_request', title: 'ğŸ” NDA Request' },
                        { id: 'insurance_compliance', title: 'ğŸ›¡ï¸ Insurance/Compliance' },
                        { id: 'month_to_month', title: 'ğŸ“… Month-to-Month' }
                    ]
                },
                {
                    title: "ğŸš« Disqualification Signals (9)",
                    count: 9,
                    handlers: [
                        { id: 'not_interested', title: 'ğŸ™… Not Interested' },
                        { id: 'doing_fine_without_help', title: 'âœ… Doing Fine Without Help' },
                        { id: 'just_researching', title: 'ğŸ” Just Researching' },
                        { id: 'email_me_info', title: 'ğŸ“§ Email Me Info' },
                        { id: 'time_waster_behaviors', title: 'â³ Time Waster Behaviors' },
                        { id: 'wont_engage_discovery', title: 'ğŸš« Won\'t Engage Discovery' },
                        { id: 'referral_only_absolutist', title: 'ğŸ¯ Referral-Only Absolutist' },
                        { id: 'no_conversion_infrastructure', title: 'ğŸ—ï¸ No Conversion Infrastructure' },
                        { id: 'unqualified_prospect', title: 'âŒ Unqualified Prospect' }
                    ]
                },
                {
                    title: "ğŸ”„ Mid-Discovery Issues (8)",
                    count: 8,
                    handlers: [
                        { id: 'mentions_referrals_data', title: 'ğŸ”— Mentions Referrals (data?)' },
                        { id: 'mentions_internal_team_data', title: 'ğŸ‘¥ Mentions Internal Team (data?)' },
                        { id: 'brand_risk_spam', title: 'ğŸš¨ Brand Risk/Spam' },
                        { id: 'capacity_overwhelm', title: 'âš–ï¸ Capacity Overwhelm' },
                        { id: 'sales_cycle_too_long', title: 'â³ Sales Cycle Too Long' },
                        { id: 'close_rate_problems', title: 'ğŸ“‰ Close Rate Problems' },
                        { id: 'founder_dependency', title: 'ğŸ‘‘ Founder Dependency' },
                        { id: 'high_churn', title: 'ğŸ”„ High Churn' }
                    ]
                },
                {
                    title: "âœ… Tic-Tac-Toe Variations (9)",
                    count: 9,
                    handlers: [
                        { id: 'it_depends_tic', title: 'ğŸ¤” "It Depends" (Tic)' },
                        { id: 'not_repeatable_tic', title: 'ğŸ”„ "Not Repeatable" (Tic)' },
                        { id: 'hedged_tic', title: 'ğŸ›¡ï¸ Hedged Tic' },
                        { id: 'conditional_tic', title: 'âš–ï¸ Conditional Tic' },
                        { id: 'rejects_a_b_c_tac', title: 'âŒ Rejects A/B/C (Tac)' },
                        { id: 'wants_to_narrow_tac', title: 'ğŸ¯ Wants to Narrow (Tac)' },
                        { id: 'toe_process_questions', title: 'ğŸ—£ï¸ Toe Process Questions' },
                        { id: 'dispute_resolution', title: 'âš”ï¸ Dispute Resolution' },
                        { id: 'verification_timing', title: 'â° Verification Timing' }
                    ]
                },
                {
                    title: "ğŸ¯ Integration/Close Issues (7)",
                    count: 7,
                    handlers: [
                        { id: 'price_shock', title: 'ğŸ’¸ Price Shock' },
                        { id: 'comparing_to_last_vendor', title: 'âš–ï¸ Comparing to Last Vendor' },
                        { id: 'whats_included', title: 'ğŸ“¦ What\'s Included?' },
                        { id: 'when_can_we_start', title: 'ğŸš€ When Can We Start?' },
                        { id: 'onboarding_questions', title: 'ğŸ“‹ Onboarding Questions' },
                        { id: 'communication_cadence', title: 'ğŸ’¬ Communication Cadence' },
                        { id: 'success_definition', title: 'ğŸ¯ Success Definition' }
                    ]
                },
                {
                    title: "ğŸ“§ Post-Scope Issues (7)",
                    count: 7,
                    handlers: [
                        { id: 'ghost_no_response', title: 'ğŸ‘» Ghost/No Response' },
                        { id: 'looks_good_but', title: 'ğŸ¤” "Looks Good BUT..."' },
                        { id: 'new_objections', title: 'ğŸš« New Objections' },
                        { id: 'legal_has_redlines', title: 'ğŸ“ Legal Has Redlines' },
                        { id: 'need_to_compare', title: 'âš–ï¸ Need to Compare' },
                        { id: 'can_we_modify', title: 'âœï¸ Can We Modify?' },
                        { id: 'immediate_yes', title: 'âœ… Immediate Yes' }
                    ]
                },
                {
                    title: "ğŸŒªï¸ Edge Cases (10)",
                    count: 10,
                    handlers: [
                        { id: 'getting_acquired', title: 'ğŸ¢ Getting Acquired' },
                        { id: 'lost_big_client', title: 'ğŸ’” Lost Big Client' },
                        { id: 'emergency_reschedule', title: 'ğŸš¨ Emergency/Reschedule' },
                        { id: 'shutting_down', title: 'ğŸ”Œ Shutting Down' },
                        { id: 'just_raised_funding', title: 'ğŸ’° Just Raised Funding' },
                        { id: 'competitor_did_this', title: 'ğŸ† Competitor Did This' },
                        { id: 'hire_you_for_something_else', title: 'ğŸ”„ Hire You for Something Else' },
                        { id: 'train_our_team_instead', title: 'ğŸ“ Train Our Team Instead' },
                        { id: 'multiple_questions_at_once', title: 'â“ Multiple Questions at Once' },
                        { id: 'i_love_this_sign_today', title: 'ğŸ‰ I Love This, Let\'s Sign Today' }
                    ]
                }
            ];

            // Debug: Check which handlers exist in data vs nav
            console.log('=== HANDLER NAVIGATION DEBUG ===');
            console.log('Total categories in navigation:', handlerCategories.length);
            
            const allHandlersInNav = new Set();
            const handlersInData = salesData?.reference_libraries?.objection_handlers?.handlers || {};
            const handlersByCategoryInData = {};
            
            // First, analyze all handlers in data and group by category
            Object.keys(handlersInData).forEach(handlerId => {
                const handler = handlersInData[handlerId];
                const category = handler.category || 'Uncategorized';
                if (!handlersByCategoryInData[category]) {
                    handlersByCategoryInData[category] = [];
                }
                handlersByCategoryInData[category].push({
                    id: handlerId,
                    title: handler.title || handlerId,
                    category: category
                });
            });
            
            console.log('\n=== HANDLERS BY CATEGORY IN DATA ===');
            Object.keys(handlersByCategoryInData).sort().forEach(category => {
                console.log(`\nğŸ“ ${category} (${handlersByCategoryInData[category].length} handlers):`);
                handlersByCategoryInData[category].forEach(h => {
                    console.log(`  âœ“ ${h.id} - "${h.title}"`);
                });
            });
            
            console.log('\n=== HANDLERS IN NAVIGATION ===');
            handlerCategories.forEach(category => {
                console.log(`\nğŸ“ ${category.title} (${category.handlers.length} handlers):`);
                category.handlers.forEach(handler => {
                    allHandlersInNav.add(handler.id);
                    const existsInData = !!handlersInData[handler.id];
                    const handlerData = handlersInData[handler.id];
                    const dataCategory = handlerData?.category || 'N/A';
                    const status = existsInData ? 'âœ“ EXISTS' : 'âœ— MISSING FROM DATA';
                    const categoryMatch = existsInData && dataCategory ? 
                        (category.title.includes(dataCategory) || dataCategory.includes(category.title.replace(/[âš¡ğŸ¬ğŸ’°âš ï¸âš™ï¸ğŸ”—âš–ï¸â°ğŸ‘¥ğŸ“ŠğŸ¯ğŸ“§ğŸŒªï¸ğŸ”€]/g, '').trim()) ? 'âœ…' : `âš ï¸ (data category: "${dataCategory}")`) : '';
                    console.log(`  ${status} ${categoryMatch} ${handler.id} - "${handler.title}"`);
                });
            });
            
            console.log('\n=== HANDLERS IN DATA BUT NOT IN NAVIGATION ===');
            const missingFromNav = [];
            Object.keys(handlersInData).forEach(handlerId => {
                if (!allHandlersInNav.has(handlerId)) {
                    const handler = handlersInData[handlerId];
                    missingFromNav.push({
                        id: handlerId,
                        title: handler.title || handlerId,
                        category: handler.category || 'Uncategorized'
                    });
                }
            });
            
            if (missingFromNav.length === 0) {
                console.log('âœ… All handlers in data are present in navigation');
            } else {
                const missingByCategory = {};
                missingFromNav.forEach(h => {
                    if (!missingByCategory[h.category]) {
                        missingByCategory[h.category] = [];
                    }
                    missingByCategory[h.category].push(h);
                });
                
                Object.keys(missingByCategory).sort().forEach(category => {
                    console.log(`\nğŸ“ ${category} (${missingByCategory[category].length} handlers):`);
                    missingByCategory[category].forEach(h => {
                        console.log(`  âœ— ${h.id} - "${h.title}"`);
                    });
                });
            }
            
            console.log('\n=== SUMMARY ===');
            console.log(`Total handlers in navigation: ${allHandlersInNav.size}`);
            console.log(`Total handlers in data: ${Object.keys(handlersInData).length}`);
            console.log(`Missing from navigation: ${missingFromNav.length}`);
            console.log(`Categories in navigation: ${handlerCategories.length}`);
            console.log(`Categories in data: ${Object.keys(handlersByCategoryInData).length}`);
            console.log('=== END DEBUG ===\n');

            handlerCategories.forEach((category, categoryIdx) => {
                // Create container for the group
                const groupContainer = document.createElement('div');
                groupContainer.className = 'nav-group-container collapsed';
                groupContainer.setAttribute('data-category-title', category.title);
                if (categoryIdx === 0) {
                    groupContainer.style.marginTop = '0';
                }

                // Add category header with toggle
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'nav-group-header collapsed';
                categoryHeader.innerHTML = `
                    <span>${category.title}</span>
                    <span class="nav-group-toggle">â–¼</span>
                `;
                
                // Toggle collapse/expand on header click
                categoryHeader.onclick = (e) => {
                    e.stopPropagation();
                    groupContainer.classList.toggle('collapsed');
                    categoryHeader.classList.toggle('collapsed');
                };
                
                groupContainer.appendChild(categoryHeader);
                console.log(`[RENDER] Category header rendered: "${category.title}"`);

                // Create container for handlers
                const handlersContainer = document.createElement('div');
                handlersContainer.className = 'nav-group-items';

                // Add handlers in this category
                category.handlers.forEach((handler, handlerIdx) => {
                    const navItem = document.createElement('div');
                    navItem.className = 'nav-handler-item';
                    navItem.setAttribute('data-id', handler.id);
                    navItem.setAttribute('data-category', category.title);

                    // Add searchable content from handler data
                    const searchHandlerData = handlersInData[handler.id];
                    if (searchHandlerData) {
                        const searchableContent = [
                            searchHandlerData.title || '',
                            searchHandlerData.trigger || '',
                            searchHandlerData.quick_response || '',
                            searchHandlerData.full_script || '',
                            searchHandlerData.key_principle || ''
                        ].join(' ').toLowerCase();
                        navItem.setAttribute('data-searchable-content', searchableContent);
                    }

                    navItem.onclick = () => loadHandler(handler.id);
                    navItem.innerHTML = `<span style="flex: 1;">${handler.title}</span>`;
                    handlersContainer.appendChild(navItem);
                    
                    // Verify handler exists in data
                    const handlerExists = !!handlersInData[handler.id];
                    const handlerData = handlersInData[handler.id];
                    const dataCategory = handlerData?.category || 'N/A';
                    console.log(`[RENDER] Handler ${handlerIdx + 1}/${category.handlers.length} rendered: "${handler.title}" (${handler.id}) - ${handlerExists ? 'âœ“ IN DATA' : 'âœ— NOT IN DATA'} ${handlerExists && dataCategory ? `[data category: "${dataCategory}"]` : ''}`);
                });

                groupContainer.appendChild(handlersContainer);
                handlerNav.appendChild(groupContainer);
            });
            
            console.log(`[RENDER] Total category headers rendered: ${handlerCategories.length}`);
            console.log(`[RENDER] Total handler items rendered: ${document.querySelectorAll('.nav-handler-item').length}`);
            console.log(`[RENDER] Total category headers in DOM: ${document.querySelectorAll('.nav-group-header').length}`);
        }

        function filterHandlers() {
            const searchTerm = document.getElementById('handler-search').value.toLowerCase();
            const handlerItems = document.querySelectorAll('.nav-handler-item');
            const groupContainers = document.querySelectorAll('.nav-group-container');
            const hasSearch = searchTerm.length > 0;

            // Filter handler items
            handlerItems.forEach(item => {
                const category = item.getAttribute('data-category').toLowerCase();
                const searchableContent = item.getAttribute('data-searchable-content') || '';

                // Search through both category and full content
                if (category.includes(searchTerm) || searchableContent.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // Update group containers: expand if has matches, show/hide based on visibility
            groupContainers.forEach(container => {
                const handlersContainer = container.querySelector('.nav-group-items');
                const header = container.querySelector('.nav-group-header');
                const itemsInGroup = handlersContainer.querySelectorAll('.nav-handler-item');
                
                // Check if any items in this group are visible
                let hasVisibleItems = false;
                itemsInGroup.forEach(item => {
                    if (item.style.display !== 'none') {
                        hasVisibleItems = true;
                    }
                });

                // If searching, expand groups with matches, collapse groups without matches
                if (hasSearch) {
                    if (hasVisibleItems) {
                        // Expand group to show matches
                        container.classList.remove('collapsed');
                        header.classList.remove('collapsed');
                        container.style.display = 'block';
                    } else {
                        // Hide group if no matches
                        container.style.display = 'none';
                    }
                } else {
                    // No search: show all groups but keep them collapsed by default
                    container.style.display = 'block';
                    // Keep collapsed state (don't force expand)
                }
            });
        }

        function clearSearch() {
            const searchInput = document.getElementById('handler-search');
            searchInput.value = '';
            
            // Show all items
            const handlerItems = document.querySelectorAll('.nav-handler-item');
            handlerItems.forEach(item => {
                item.style.display = 'flex';
            });
            
            // Collapse all groups when search is cleared
            const groupContainers = document.querySelectorAll('.nav-group-container');
            groupContainers.forEach(container => {
                container.classList.add('collapsed');
                const header = container.querySelector('.nav-group-header');
                if (header) header.classList.add('collapsed');
                container.style.display = 'block'; // Show all groups
            });
            
            toggleClearButton(); // Hide the clear button
            searchInput.focus(); // Return focus to input for better UX
        }

        function toggleClearButton() {
            const searchInput = document.getElementById('handler-search');
            const clearButton = document.getElementById('clear-search');
            clearButton.style.display = searchInput.value.length > 0 ? 'block' : 'none';
        }

        function loadHandler(handlerId, updateURLParam = true) {
            // Debug: Check data structure
            console.log(`\n[LOAD HANDLER] Loading handler: "${handlerId}"`);
            console.log('[LOAD HANDLER] salesData exists:', !!salesData);
            console.log('[LOAD HANDLER] reference_libraries exists:', !!(salesData && salesData.reference_libraries));
            console.log('[LOAD HANDLER] objection_handlers exists:', !!(salesData && salesData.reference_libraries && salesData.reference_libraries.objection_handlers));
            console.log('[LOAD HANDLER] handlers exists:', !!(salesData && salesData.reference_libraries && salesData.reference_libraries.objection_handlers && salesData.reference_libraries.objection_handlers.handlers));

            // Get handler data from the JavaScript data structure
            let handlerData = null;
            if (salesData && salesData.reference_libraries && salesData.reference_libraries.objection_handlers && salesData.reference_libraries.objection_handlers.handlers) {
                handlerData = salesData.reference_libraries.objection_handlers.handlers[handlerId];
                if (handlerData) {
                    console.log(`[LOAD HANDLER] âœ“ Handler found in data`);
                    console.log(`[LOAD HANDLER] Title: "${handlerData.title}"`);
                    console.log(`[LOAD HANDLER] Category: "${handlerData.category || 'N/A'}"`);
                    console.log(`[LOAD HANDLER] Trigger: "${handlerData.trigger || 'N/A'}"`);
                } else {
                    console.log(`[LOAD HANDLER] âœ— Handler NOT found in data`);
                    console.log(`[LOAD HANDLER] Available handler IDs (first 20):`, Object.keys(salesData.reference_libraries.objection_handlers.handlers).slice(0, 20));
                }
            }

            // Fallback for testing/development
            if (!handlerData) {
                console.log('Using fallback for handler:', handlerId);
                handlerData = {
                    title: handlerId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    category: 'Handler Library',
                    trigger: 'When prospects raise this objection during discovery',
                    quick_response: 'Quick response for ' + handlerId,
                    full_script: 'Full script content would go here for ' + handlerId,
                    key_principle: 'Key principle for handling ' + handlerId
                };
            }

            // Update URL if requested
            if (updateURLParam) {
                updateURL('handler', handlerId);
            }

            // Update active state
            document.querySelectorAll('.nav-handler-item').forEach(nav => nav.classList.remove('active'));
            const navItem = document.querySelector(`[data-id="${handlerId}"]`);
            if (navItem) navItem.classList.add('active');

            const contentArea = document.getElementById('content-area');
            let html = '';

            // Header
            html += `
                <div class="content-header">
                    <span class="content-category">${handlerData.category}</span>
                    <h2 class="content-title">${handlerData.title}</h2>
                    <p class="content-purpose">${handlerData.trigger}</p>
                </div>
                <div class="content-body">
            `;

            // Quick Response
            if (handlerData.quick_response) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">âš¡ Quick Response</div>
                        <p>${linkifyReferences(handlerData.quick_response)}</p>
                    </div>
                `;
            }

            // Full Script
            if (handlerData.full_script) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">ğŸ“‹ Full Script</div>
                        <div class="script-block">${formatScript(linkifyReferences(handlerData.full_script))}</div>
                    </div>
                `;
            }

            // Key Principle
            if (handlerData.key_principle) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">ğŸ¯ Key Principle</div>
                        <p>${linkifyReferences(handlerData.key_principle)}</p>
                    </div>
                `;
            }

            // Story Mode (for Objection Positioningâ„¢)
            if (handlerData.story_mode) {
                html += `
                    <div style="margin: 2.5rem 0; padding: 2rem; background: var(--bg-secondary); border: 2px solid var(--primary-color); border-radius: 12px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.75rem;">ğŸ­</span>
                            <h3 style="color: var(--primary-color); font-size: 1.3rem; font-weight: 700; margin: 0;">${handlerData.story_mode.title}</h3>
                        </div>
                        <div class="info-box" style="background: var(--bg-secondary); border-left-color: var(--accent-yellow); margin-bottom: 1.5rem;">
                            <div class="info-box-title">â±ï¸ When to Use This</div>
                            <p style="font-style: italic; color: var(--text-secondary);">${handlerData.story_mode.when_to_use}</p>
                        </div>
                        <div class="script-block">
                            ${formatScript(handlerData.story_mode.script)}
                        </div>
                    </div>
                `;
            }

            // Return to Track button
            html += `
                <div class="return-to-track">
                    <button onclick="returnToTrack()" class="return-btn">â†©ï¸ Return to Main Track</button>
                </div>
            `;

            html += '</div>';
            contentArea.innerHTML = html;
        }

        function returnToTrack() {
            // Return to the last sequential content or opening frame
            const lastSequential = localStorage.getItem('lastSequentialContent') || 'opening_frame';
            loadContent(lastSequential);
        }

        // ===== ROUTER =====
        // Router to handle URL updates and page restoration
        
        function updateURL(type, id) {
            let path = '/';
            if (type === 'content') {
                path = `/content/${id}`;
            } else if (type === 'reference') {
                path = `/reference/${id}`;
            } else if (type === 'objection') {
                path = `/objection/${id}`;
            }
            
            // Update URL without reloading the page
            window.history.pushState({ type, id }, '', path);
        }
        
        function handleRoute() {
            const path = window.location.pathname;
            
            // Default to welcome screen if at root
            if (path === '/' || path === '') {
                showWelcomeScreen();
                return;
            }
            
            // Parse URL path
            const parts = path.split('/').filter(p => p);
            
            if (parts.length >= 2) {
                const type = parts[0];
                const id = parts[1];
                
                if (type === 'content') {
                    loadContent(id, true, false); // Skip URL update to avoid double push
                } else if (type === 'reference') {
                    loadReferenceContent(id, false); // Skip URL update
                } else if (type === 'objection') {
                    const objectionNum = parseInt(id, 10);
                    if (!isNaN(objectionNum)) {
                        loadObjection(objectionNum, false); // Skip URL update
                    }
                } else if (type === 'handler') {
                    loadHandler(id, false); // Skip URL update
                }
            }
        }
        
        function showWelcomeScreen() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="welcome-screen">
                    <h2>Revenue Advisory Sales Assistant</h2>
                    <p>Navigate through the Call One Discovery process using the sidebar. Access sequential flow for the call structure, or jump to reference libraries for CARPET, emotional discovery, and more.</p>
                    <a href="#" class="welcome-cta" onclick="loadContent('opening_frame'); return false;">Start Call One â†’</a>
                </div>
            `;
            
            // Clear active states
            document.querySelectorAll('.nav-item, .nav-subitem').forEach(nav => nav.classList.remove('active'));
        }
        
        // Listen for browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            handleRoute();
        });
        
        function loadObjection(objectionNum, updateURLParam = true) {
            const refData = salesData.reference_libraries.discovery_objection_handling_os;
            const obj = refData.objections.find(o => o.number === objectionNum);
            
            if (!obj) return;

            // Update URL if requested
            if (updateURLParam) {
                updateURL('objection', objectionNum);
            }

            // Update active state
            document.querySelectorAll('.nav-item, .nav-subitem').forEach(nav => nav.classList.remove('active'));
            const navItem = document.querySelector(`[data-id="objection_${objectionNum}"]`);
            if (navItem) navItem.classList.add('active');

            const contentArea = document.getElementById('content-area');
            let html = '';

            // Header
            html += `
                <div class="content-header">
                    <span class="content-category">Discovery Objection #${obj.number}</span>
                    <h2 class="content-title">${obj.title}</h2>
                    <p class="content-purpose">${obj.category}</p>
                </div>
                <div class="content-body">
            `;

            // The objection / where it shows up
            if (obj.the_objection) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">The Objection</div>
                        <p>${obj.the_objection}</p>
                    </div>
                `;
            }
            if (obj.where_it_shows_up) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Where It Shows Up</div>
                        <p>${linkifyReferences(obj.where_it_shows_up)}</p>
                    </div>
                `;
            }

            // Reference Handler (for objections that point to interrupt handlers)
            if (obj.reference_handler) {
                html += `
                    <div class="info-box" style="border-left: 4px solid var(--primary-color); background: rgba(37, 99, 235, 0.05);">
                        <div class="info-box-title">ğŸ“Œ Primary Handler</div>
                        <p style="font-size: 1.05rem; line-height: 1.7;">${linkifyReferences(obj.reference_handler)}</p>
                    </div>
                `;
            }

            // Quick Summary (for reference-only objections)
            if (obj.quick_summary) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Quick Summary</div>
                        <p style="font-weight: 600;">${linkifyReferences(obj.quick_summary)}</p>
                    </div>
                `;
            }

            // Why they do it
            if (obj.why_they_do_it && obj.why_they_do_it.length > 0) {
                html += `
                    <div class="info-box warning">
                        <div class="info-box-title">Why They Do It</div>
                        <ul class="bullet-list">
                `;
                obj.why_they_do_it.forEach(reason => {
                    html += `<li>${linkifyReferences(reason)}</li>`;
                });
                html += `</ul></div>`;
            }

            // How to handle (structured as steps)
            if (obj.how_to_handle && obj.how_to_handle.length > 0) {
                html += `
                    <div class="info-box" style="margin: 1.5rem 0;">
                        <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.15rem; font-weight: 700;">How to Handle It:</h4>
                `;
                obj.how_to_handle.forEach((step, idx) => {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="color: var(--primary-color); margin-bottom: 0.5rem; font-weight: 600;">${idx + 1}. ${step.step}</h5>
                    `;
                    if (step.script) {
                        html += `<div class="script-block">${formatScript(step.script)}</div>`;
                    }
                    if (step.goal) {
                        html += `<p style="font-style: italic; color: var(--text-secondary); margin-top: 0.5rem;">${step.goal}</p>`;
                    }
                    if (step.benchmarks && step.benchmarks.length > 0) {
                        html += `<ul class="bullet-list" style="margin-top: 0.5rem;">`;
                        step.benchmarks.forEach(b => {
                            html += `<li>${b}</li>`;
                        });
                        html += `</ul>`;
                    }
                    if (step.content) {
                        html += `<p style="margin-top: 0.5rem;">${linkifyReferences(step.content)}</p>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Core playbook (array of principles)
            if (obj.core_playbook && obj.core_playbook.length > 0) {
                html += `
                    <div style="margin: 1.5rem 0;">
                        <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.15rem; font-weight: 700;">Core Playbook:</h4>
                `;
                obj.core_playbook.forEach((item, idx) => {
                    html += `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px;">
                            <h5 style="color: var(--primary-color); margin-bottom: 0.5rem; font-weight: 600;">${item.principle}</h5>
                    `;
                    if (item.content) {
                        html += `<p style="margin-bottom: 0.5rem;">${linkifyReferences(item.content)}</p>`;
                    }
                    if (item.script) {
                        html += `<div class="script-block">${formatScript(item.script)}</div>`;
                    }
                    if (item.why) {
                        html += `<p style="font-style: italic; color: var(--text-secondary); margin-top: 0.5rem;">${linkifyReferences(item.why)}</p>`;
                    }
                    if (item.examples && item.examples.length > 0) {
                        html += `<ul class="bullet-list" style="margin-top: 0.5rem;">`;
                        item.examples.forEach(ex => {
                            html += `<li>${ex}</li>`;
                        });
                        html += `</ul>`;
                    }
                    if (item.remember && item.remember.length > 0) {
                        html += `<div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-main); border-radius: 4px; border: 1px solid var(--border-color);"><strong>Remember:</strong><ul class="bullet-list" style="margin-top: 0.5rem;">`;
                        item.remember.forEach(r => {
                            html += `<li>${r}</li>`;
                        });
                        html += `</ul></div>`;
                    }
                    if (item.steps && item.steps.length > 0) {
                        html += `<ul class="bullet-list" style="margin-top: 0.5rem;">`;
                        item.steps.forEach(s => {
                            html += `<li>${s}</li>`;
                        });
                        html += `</ul>`;
                    }
                    if (item.impact) {
                        html += `<p style="margin-top: 0.75rem; font-weight: 600; color: var(--accent-green);">âœ“ ${item.impact}</p>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Pacing technique (special section for objection 5)
            if (obj.pacing_technique) {
                html += `
                    <div class="info-box advisor-note" style="margin: 1.5rem 0;">
                        <div class="info-box-title">${obj.pacing_technique.title}</div>
                        <p>${obj.pacing_technique.content}</p>
                        <div style="margin-top: 1rem;">
                            <strong>Questions to ask:</strong>
                            <ul class="bullet-list" style="margin-top: 0.5rem;">
                `;
                obj.pacing_technique.questions.forEach(q => {
                    html += `<li>${q}</li>`;
                });
                html += `
                            </ul>
                        </div>
                        <p style="margin-top: 1rem; font-weight: 600;">${obj.pacing_technique.anchor}</p>
                        <div class="script-block" style="margin-top: 1rem;">${formatScript(obj.pacing_technique.full_script)}</div>
                    </div>
                `;
            }

            // Capitalization framing (objection 5)
            if (obj.capitalization_framing) {
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                        <h4 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${obj.capitalization_framing.title}</h4>
                        <div class="info-box warning">
                            <div class="info-box-title">Core Principle</div>
                            <p style="font-weight: 600;">${obj.capitalization_framing.principle}</p>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Key Reframe</div>
                            <p style="font-weight: 600; font-style: italic;">${obj.capitalization_framing.key_reframe}</p>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 1rem;">Scripts to Use:</h5>
                `;
                obj.capitalization_framing.scripts.forEach((script, idx) => {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 600;">Option ${idx + 1}:</p>
                            <div class="script-block">${formatScript(script)}</div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            // Discount handling (objection 5)
            if (obj.discount_handling) {
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-red); border-radius: 6px;">
                        <h4 style="color: var(--accent-red); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${obj.discount_handling.title}</h4>
                        <div class="info-box warning">
                            <div class="info-box-title">âš ï¸ Golden Rule</div>
                            <p style="font-weight: 600;">${obj.discount_handling.golden_rule}</p>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">Core Position</div>
                            <p>${obj.discount_handling.core_position}</p>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.75rem;">Primary Script:</h5>
                            <div class="script-block">${formatScript(obj.discount_handling.primary_script)}</div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.75rem;">If They Push Back:</h5>
                            <div class="script-block">${formatScript(obj.discount_handling.if_they_push)}</div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.75rem;">Scope Reduction Example:</h5>
                            <div class="script-block">${formatScript(obj.discount_handling.scope_reduction_example)}</div>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1.5rem;">
                            <div class="info-box-title">Advisor Notes</div>
                            <ul class="bullet-list">
                `;
                obj.discount_handling.advisor_notes.forEach(note => {
                    html += `<li>${linkifyReferences(note)}</li>`;
                });
                html += `
                            </ul>
                        </div>
                    </div>
                `;
            }

            // Asset pack
            if (obj.asset_pack && obj.asset_pack.length > 0) {
                html += `
                    <div class="info-box" style="margin: 1rem 0;">
                        <div class="info-box-title">Asset Pack to Send</div>
                        <ul class="bullet-list">
                `;
                obj.asset_pack.forEach(asset => {
                    html += `<li>${asset}</li>`;
                });
                html += `</ul></div>`;
            }

            // Principle (for objection 7)
            if (obj.principle) {
                html += `
                    <div class="info-box advisor-note">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">Principle:</p>
                        <p>${obj.principle}</p>
                    </div>
                `;
            }

            // What it does
            if (obj.what_it_does && obj.what_it_does.length > 0) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">What This Does</div>
                        <ul class="bullet-list">
                `;
                obj.what_it_does.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += `</ul></div>`;
            }

            // Specific handles (for mechanism questions)
            if (obj.specific_handles && obj.specific_handles.length > 0) {
                html += `
                    <div style="margin: 1.5rem 0;">
                        <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.15rem; font-weight: 700;">Specific Handles:</h4>
                `;
                obj.specific_handles.forEach(handle => {
                    html += `
                        <div style="margin-bottom: 2rem; padding: 1.25rem; background: var(--bg-secondary); border-left: 3px solid var(--primary-color); border-radius: 4px;">
                            <p style="font-weight: 700; color: var(--text-primary); margin-bottom: 0.75rem;">${handle.question}</p>
                            <p style="margin-bottom: 0.5rem;"><strong>Lean in:</strong> "${handle.lean_in}"</p>
                            <p style="margin-bottom: 0.5rem;"><strong>Reframe:</strong> ${handle.reframe}</p>
                            <p style="font-style: italic; color: var(--text-secondary);"><strong>Anchor back:</strong> "${handle.anchor_back}"</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Teaching device / teaching notes
            if (obj.teaching_device) {
                html += `
                    <div class="info-box warning">
                        <div class="info-box-title">Teaching Device</div>
                        <p>${obj.teaching_device}</p>
                    </div>
                `;
            }
            if (obj.teaching_notes && obj.teaching_notes.length > 0) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Teaching Notes for Members</div>
                        <ul class="bullet-list">
                `;
                obj.teaching_notes.forEach(note => {
                    html += `<li>${linkifyReferences(note)}</li>`;
                });
                html += `</ul></div>`;
            }

            // Conclusion
            if (obj.conclusion && obj.conclusion.length > 0) {
                html += `
                    <div style="margin: 1rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
                        <strong>Key Takeaways:</strong>
                        <ul class="bullet-list" style="margin-top: 0.5rem;">
                `;
                obj.conclusion.forEach(point => {
                    html += `<li>${point}</li>`;
                });
                html += `</ul></div>`;
            }

            // Context / Why it works
            if (obj.context) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">${obj.context}</div>
                `;
                if (obj.why_it_works && obj.why_it_works.length > 0) {
                    html += `<ul class="bullet-list">`;
                    obj.why_it_works.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += `</ul>`;
                }
                html += `</div>`;
            }

            // Script (standalone)
            if (obj.script) {
                html += `
                    <div style="margin: 1rem 0;">
                        <div class="info-box-title">Script</div>
                        <div class="script-block">${formatScript(obj.script)}</div>
                    </div>
                `;
            }

            // Example exchange
            if (obj.example_exchange) {
                html += `
                    <div class="two-column" style="margin: 1.5rem 0;">
                        <div class="column-box">
                            <h4>Prospect</h4>
                            <p>"${obj.example_exchange.prospect}"</p>
                        </div>
                        <div class="column-box">
                            <h4>You</h4>
                            <p>"${obj.example_exchange.you}"</p>
                        </div>
                    </div>
                `;
            }

            // Sample language
            if (obj.sample_language) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Sample Language</div>
                        <div class="script-block">${formatScript(obj.sample_language)}</div>
                    </div>
                `;
            }

            // Pivot examples
            if (obj.pivot_examples) {
                html += `
                    <div style="margin: 2rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">Pivot Examples</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">Click on any pivot example to navigate to the relevant discovery section:</p>
                `;
                obj.pivot_examples.forEach((example, idx) => {
                    // Handle both old format (string) and new format (object)
                    const isObject = typeof example === 'object' && example !== null;
                    const text = isObject ? example.text : example;
                    const linkTo = isObject ? example.link_to : null;
                    const linkText = isObject ? example.link_text : null;
                    
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <div class="script-block" style="cursor: ${linkTo ? 'pointer' : 'default'}; transition: all 0.2s;" ${linkTo ? `onclick="loadContent('${linkTo}'); return false;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.15)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"` : ''}>
                                ${formatScript(text)}
                            </div>
                            ${linkTo ? `<p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--primary-color); font-weight: 600; text-align: center;">â†“ Click to view: ${linkText}</p>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Key lesson
            if (obj.key_lesson) {
                html += `
                    <div class="info-box advisor-note" style="margin-top: 1.5rem;">
                        <div class="info-box-title">Key Lesson</div>
                        <p style="font-size: 1.05rem; line-height: 1.7;">${linkifyReferences(obj.key_lesson)}</p>
                    </div>
                `;
            }

            // Where to go next
            if (obj.where_to_go_next) {
                const wtgn = obj.where_to_go_next;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(37, 99, 235, 0.05) 100%); border-left: 4px solid var(--primary-color); border-radius: 6px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">ğŸ¯ ${wtgn.title}</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">${wtgn.guidance}</p>
                `;
                if (wtgn.options && wtgn.options.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">`;
                    wtgn.options.forEach(option => {
                        html += `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 6px;">
                                <p style="margin-bottom: 0.5rem;"><strong style="color: var(--primary-color);">If:</strong> ${option.if}</p>
                                <p><strong style="color: var(--accent-green);">Then:</strong> ${option.then}</p>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                if (wtgn.default) {
                    html += `
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Default Path</div>
                            <p>${wtgn.default}</p>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            // Question Groups (for objections like #14)
            if (obj.question_groups && obj.question_groups.length > 0) {
                obj.question_groups.forEach(group => {
                    html += `
                        <div class="question-group info-box">
                            <div class="question-group-header">
                                <span class="question-group-emoji">${group.emoji}</span>
                                <span class="question-group-title">${group.title}</span>
                            </div>
                            <div class="question-group-list">
                    `;
                    group.questions.forEach((q, idx) => {
                        const questionId = `${obj.id}_${group.title.replace(/\s+/g, '_')}_${idx}`;
                        const isChecked = localStorage.getItem(`question_${questionId}`) === 'true';
                        html += `<div class="script-block question-item ${isChecked ? 'asked' : ''}" onclick="toggleQuestion('${questionId}', this)">
                            ${idx + 1}. ${q}
                        </div>`;
                    });
                    html += `</div></div>`;
                });
            }

            html += `</div>`;
            contentArea.innerHTML = html;
            contentArea.scrollTop = 0;
        }

        function loadContent(itemId, scrollToTop = true, updateURLParam = true) {
            const item = salesData.sequential_flow.call_one.find(i => i.id === itemId);
            if (!item) return;

            // Store last sequential content for breadcrumb trail
            localStorage.setItem('lastSequentialContent', itemId);

            // Update URL if requested
            if (updateURLParam) {
                updateURL('content', itemId);
            }

            // Update active state
            document.querySelectorAll('.nav-item, .nav-subitem').forEach(nav => nav.classList.remove('active'));
            const navItem = document.querySelector(`[data-id="${itemId}"]`);
            if (navItem) {
                navItem.classList.add('active');
                // Expand the parent section
                const parentSection = navItem.closest('.nav-section');
                if (parentSection && parentSection.classList.contains('collapsed')) {
                    parentSection.classList.remove('collapsed');
                }
            }

            // Collapse all other sections
            document.querySelectorAll('.nav-section').forEach(section => {
                if (!section.contains(navItem)) {
                    section.classList.add('collapsed');
                }
            });

            const contentArea = document.getElementById('content-area');
            let html = '';

            // Header
            html += `
                <div class="content-header">
                    <span class="content-category">${item.category === 'interrupt' ? 'Objection Handler' : item.category}${item.section ? ` â€” Section ${item.section}` : ''}</span>
                    <h2 class="content-title">${item.title}</h2>
                    ${item.purpose ? `<p class="content-purpose">${item.purpose}</p>` : ''}
                </div>
                <div class="content-body">
            `;

            // Trigger (for interrupts)
            if (item.trigger) {
                html += `
                    <div class="info-box warning">
                        <div class="info-box-title">Trigger</div>
                        <p>${item.trigger}</p>
                    </div>
                `;
            }

            // Where it shows up
            if (item.where_it_shows_up) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Where It Shows Up</div>
                        <p>${linkifyReferences(item.where_it_shows_up)}</p>
                    </div>
                `;
            }

            // Context/Golden Rule
            if (item.context) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Context</div>
                        <p>${linkifyReferences(item.context)}</p>
                    </div>
                `;
            }

            if (item.golden_rule) {
                html += `
                    <div class="info-box warning">
                        <div class="info-box-title">Golden Rule</div>
                        <p>${linkifyReferences(item.golden_rule)}</p>
                    </div>
                `;
            }

            if (item.core_principle) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Core Principle</div>
                        <p>${linkifyReferences(item.core_principle)}</p>
                    </div>
                `;
            }

            if (item.primary_reframe) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Primary Reframe Script</div>
                        <div class="script-block">${formatScript(item.primary_reframe)}</div>
                    </div>
                `;
            }

            if (item.validation_spins && item.validation_spins.length > 0) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Validation Spins â€” Choose Your Response</div>
                        <ul class="bullet-list">
                `;
                item.validation_spins.forEach(spin => {
                    html += `<li>"${spin}"</li>`;
                });
                html += `</ul></div>`;
            }

            if (item.polite_disqualification) {
                html += `
                    <div class="info-box warning">
                        <div class="info-box-title">Polite Disqualification Script</div>
                        <div class="script-block">${formatScript(item.polite_disqualification)}</div>
                    </div>
                `;
            }

            // Why they do it (for objections)
            if (item.why_they_do_it && item.why_they_do_it.length > 0) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Why They Do It</div>
                        <ul class="bullet-list">
                `;
                item.why_they_do_it.forEach(reason => {
                    html += `<li>${reason}</li>`;
                });
                html += `</ul></div>`;
            }

            // Handle steps (for procedural objections)
            if (item.handle_steps && item.handle_steps.length > 0) {
                html += `
                    <div class="info-box" style="margin: 2rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.25rem;">How to Handle It:</h3>
                `;
                item.handle_steps.forEach((stepObj, idx) => {
                    html += `
                        <div style="margin-bottom: 2rem; padding-left: 1rem; border-left: 3px solid var(--primary-color);">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem; font-weight: 700;">${stepObj.step}</h4>
                    `;
                    if (stepObj.script) {
                        html += `<div class="script-block" style="margin-bottom: 1rem;">${formatScript(stepObj.script)}</div>`;
                    }
                    if (stepObj.goal) {
                        html += `<p style="font-style: italic; color: var(--text-secondary); margin-bottom: 0.5rem;">${stepObj.goal}</p>`;
                    }
                    if (stepObj.questions && stepObj.questions.length > 0) {
                        html += `<ul class="bullet-list">`;
                        stepObj.questions.forEach(q => {
                            html += `<li>${q}</li>`;
                        });
                        html += `</ul>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // How to handle (for pricing objections - uses content field)
            if (item.how_to_handle && item.how_to_handle.length > 0) {
                html += `
                    <div class="info-box" style="margin: 2rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.25rem;">How to Handle It:</h3>
                `;
                item.how_to_handle.forEach((stepObj, idx) => {
                    html += `
                        <div style="margin-bottom: 2rem; padding-left: 1rem; border-left: 3px solid var(--primary-color);">
                            <h4 style="color: var(--primary-color); margin-bottom: 0.75rem; font-weight: 700;">${stepObj.step}</h4>
                    `;
                    if (stepObj.content) {
                        html += `<p style="margin-bottom: 0.5rem; line-height: 1.6;">${linkifyReferences(stepObj.content)}</p>`;
                    }
                    if (stepObj.script) {
                        html += `<div class="script-block" style="margin-bottom: 1rem;">${formatScript(stepObj.script)}</div>`;
                    }
                    if (stepObj.goal) {
                        html += `<p style="font-style: italic; color: var(--text-secondary); margin-bottom: 0.5rem;">${stepObj.goal}</p>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Key lesson
            if (item.key_lesson) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Key Lesson</div>
                        <p>${linkifyReferences(item.key_lesson)}</p>
                    </div>
                `;
            }

            // Advisor Mindset/Guidance
            if (item.advisor_mindset) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Advisor Mindset</div>
                        <p>${item.advisor_mindset}</p>
                    </div>
                `;
            }

            if (item.advisor_guidance) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Advisor Guidance</div>
                        <p>${item.advisor_guidance}</p>
                    </div>
                `;
            }

            // Main Script
            if (item.script) {
                html += `
                    <div class="script-block">${formatScript(item.script)}</div>
                `;
            }

            // Story Mode (for Objection Positioningâ„¢)
            if (item.story_mode) {
                html += `
                    <div style="margin: 2.5rem 0; padding: 2rem; background: var(--bg-secondary); border: 2px solid var(--primary-color); border-radius: 12px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.75rem;">ğŸ­</span>
                            <h3 style="color: var(--primary-color); font-size: 1.3rem; font-weight: 700; margin: 0;">${item.story_mode.title}</h3>
                        </div>
                        <div class="info-box" style="background: var(--bg-secondary); border-left-color: var(--accent-yellow); margin-bottom: 1.5rem;">
                            <div class="info-box-title">â±ï¸ When to Use This</div>
                            <p style="font-style: italic; color: var(--text-secondary);">${item.story_mode.when_to_use}</p>
                        </div>
                        <div class="script-block">
                            ${formatScript(item.story_mode.script)}
                        </div>
                    </div>
                `;
            }

            // Capitalization Framing (for pricing objections)
            if (item.capitalization_framing) {
                const cap = item.capitalization_framing;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                        <h4 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${cap.title}</h4>
                        <div style="margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.5rem;">${cap.principle}</p>
                            <p style="font-weight: 600; font-style: italic; color: var(--primary-color);">${cap.key_reframe}</p>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h5 style="color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 700;">Scripts for When They Push on Upfront Payment:</h5>
                `;
                cap.scripts.forEach((script, idx) => {
                    html += `
                        <div class="script-block" style="margin-bottom: 1rem;">
                            ${formatScript(script)}
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            // Intro for discovery sections
            if (item.intro) {
                html += `
                    <div class="script-block">${formatScript(item.intro)}</div>
                `;
            }

            // Question Groups
            if (item.question_groups && item.question_groups.length > 0) {
                let questionNumber = 1;
                item.question_groups.forEach((group, groupIndex) => {
                    html += `
                        <div class="question-group info-box collapsed">
                            <div class="question-group-header" onclick="toggleQuestionGroup(this)">
                                <span class="question-group-emoji">${group.emoji}</span>
                                <span class="question-group-title">${group.title}</span>
                                <span class="question-group-toggle">â–¼</span>
                            </div>
                            <div class="question-group-list">
                    `;
                    group.questions.forEach((q, idx) => {
                        html += `<div class="script-block question-item">${questionNumber}. ${q}</div>`;
                        questionNumber++;
                    });
                    html += `</div></div>`;
                });
            }

            // Tic Admission Gathering (for Bottom of Funnel)
            if (item.tic_admission_gathering) {
                const tic = item.tic_admission_gathering;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--primary-color); border-radius: 6px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.3rem; font-weight: 700;">${tic.title}</h3>
                        <div class="info-box">
                            <div class="info-box-title">Purpose</div>
                            <p>${tic.purpose}</p>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">Objective</div>
                            <p style="font-weight: 600;">${tic.objective}</p>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h4 style="color: var(--text-primary); font-weight: 700; margin-bottom: 0.75rem;">How to Execute:</h4>
                            <ul class="bullet-list">
                `;
                tic.how_to_execute.forEach(step => {
                    html += `<li>${step}</li>`;
                });
                html += `
                            </ul>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1.5rem;">
                            <div class="info-box-title">Admission Script</div>
                            <div class="script-block">${formatScript(tic.admission_script)}</div>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">What You're Capturing</div>
                            <p>${linkifyReferences(tic.what_youre_capturing)}</p>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Advisor Notes</div>
                            <ul class="bullet-list">
                `;
                tic.advisor_notes.forEach(note => {
                    html += `<li>${linkifyReferences(note)}</li>`;
                });
                html += `
                            </ul>
                        </div>
                    </div>
                `;
            }

            // Soft commitment
            if (item.soft_commitment) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Soft Process Commitment</div>
                        <div class="script-block">${formatScript(item.soft_commitment)}</div>
                    </div>
                `;
            }

            if (item.soft_commitment_question) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Soft Commitment Question</div>
                        <div class="script-block">${formatScript(item.soft_commitment_question)}</div>
                    </div>
                `;
            }

            // Fork paths - show choice buttons
            if (item.paths) {
                html += `
                    <div class="fork-choice">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Choose Your Economy:</h3>
                        <div class="fork-buttons">
                `;
                item.paths.forEach(path => {
                    html += `
                        <button class="fork-btn" onclick="showEconomyPath('${itemId}', '${path.id}')">
                            <div class="fork-btn-title">${path.economy}</div>
                            <div class="fork-btn-desc">${path.context}</div>
                        </button>
                    `;
                });
                html += `
                        </div>
                    </div>
                    <div id="economy-script-display"></div>
                `;
            }

            // Pivot examples
            if (item.pivot_examples) {
                html += `
                    <div style="margin: 2rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">Pivot Examples</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">Click on any pivot example to navigate to the relevant discovery section:</p>
                `;
                item.pivot_examples.forEach((example, idx) => {
                    // Handle both old format (string) and new format (object)
                    const isObject = typeof example === 'object' && example !== null;
                    const text = isObject ? example.text : example;
                    const linkTo = isObject ? example.link_to : null;
                    const linkText = isObject ? example.link_text : null;
                    
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <div class="script-block" style="cursor: ${linkTo ? 'pointer' : 'default'}; transition: all 0.2s;" ${linkTo ? `onclick="loadContent('${linkTo}'); return false;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.15)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"` : ''}>
                                ${formatScript(text)}
                            </div>
                            ${linkTo ? `<p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--primary-color); font-weight: 600; text-align: center;">â†“ Click to view: ${linkText}</p>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // The Definition (for "Tac" - Defining Qualified Opportunities)
            if (item.the_definition) {
                const def = item.the_definition;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                        <h3 style="color: var(--accent-green); margin-bottom: 1.5rem; font-size: 1.3rem; font-weight: 700;">${def.title}</h3>
                `;
                def.components.forEach(comp => {
                    html += `
                        <div class="info-box" style="margin-bottom: 1rem;">
                            <div class="info-box-title">${comp.letter} â€” ${comp.name}</div>
                            <p>${comp.description}</p>
                        </div>
                    `;
                });
                html += `
                        <div class="info-box warning" style="margin-top: 1.5rem;">
                            <div class="info-box-title">âš ï¸ Deliberate Omission</div>
                            <p>${def.deliberate_omission}</p>
                        </div>
                    </div>
                `;
            }

            // How to Introduce It (for "Tac")
            if (item.how_to_introduce_it) {
                const intro = item.how_to_introduce_it;
                html += `
                    <div style="margin: 2rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">How to Introduce the Definition</h3>
                        <div class="info-box">
                            <div class="info-box-title">Posture & Tone</div>
                            <p><strong>Posture:</strong> ${intro.posture}</p>
                            <p style="margin-top: 0.5rem;"><strong>Tone:</strong> ${intro.tone}</p>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Primary Script</div>
                            <div class="script-block">${formatScript(intro.script)}</div>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">Clarifying Titles</div>
                            <div class="script-block">${formatScript(intro.clarifying_titles)}</div>
                        </div>
                    </div>
                `;
            }

            // Handling Constraints (for "Tac")
            if (item.handling_constraints) {
                const constraints = item.handling_constraints;
                html += `
                    <div class="info-box" style="margin: 1.5rem 0;">
                        <div class="info-box-title">${constraints.title}</div>
                        <p style="margin-bottom: 1rem;"><strong>Context:</strong> ${constraints.context}</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Response:</strong></p>
                        <div class="script-block">${formatScript(constraints.response)}</div>
                        <p style="margin-top: 1rem;"><em>Principle: ${constraints.principle}</em></p>
                    </div>
                `;
            }

            // Problem-Aware Framing (for "Tac")
            if (item.problem_aware_framing) {
                const paf = item.problem_aware_framing;
                html += `
                    <div class="info-box" style="margin: 1.5rem 0;">
                        <div class="info-box-title">${paf.title}</div>
                        <p style="margin-bottom: 1rem;">${paf.explanation}</p>
                        <p><strong>Reinforcement:</strong></p>
                        <div class="script-block">${formatScript(paf.reinforcement)}</div>
                    </div>
                `;
            }

            // The Directional Yes (for "Tac")
            if (item.the_directional_yes) {
                const yes = item.the_directional_yes;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                        <h3 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.3rem; font-weight: 700;">${yes.title}</h3>
                        <div class="info-box">
                            <div class="info-box-title">Objective</div>
                            <p style="font-weight: 600;">${yes.objective}</p>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">What This Creates</div>
                            <p>${yes.what_this_creates}</p>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">Document Immediately</div>
                            <p>${yes.document_immediately}</p>
                        </div>
                    </div>
                `;
            }

            // Critical Context (for "Tac" - defining_qualified_opportunities)
            if (item.critical_context) {
                html += `
                    <div class="info-box warning" style="margin: 1.5rem 0;">
                        <div class="info-box-title">âš ï¸ Critical Context</div>
                        <p style="font-weight: 600; font-size: 1.05rem;">${item.critical_context}</p>
                    </div>
                `;
            }

            // Operator Objective (for "Tac" - defining_qualified_opportunities)
            if (item.operator_objective) {
                html += `
                    <div class="info-box advisor-note" style="margin: 1.5rem 0;">
                        <div class="info-box-title">Operator Objective</div>
                        <p>${item.operator_objective}</p>
                    </div>
                `;
            }

            // Why This Matters (for "Tac")
            if (item.why_this_matters) {
                const why = item.why_this_matters;
                html += `
                    <div class="info-box" style="margin: 1.5rem 0;">
                        <div class="info-box-title">${why.title}</div>
                        <ul class="bullet-list">
                `;
                why.points.forEach(point => {
                    html += `<li>${point}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }

            // The Toe - Power Transfer Offer (for "Tac")
            if (item.the_toe_power_transfer_offer) {
                const toe = item.the_toe_power_transfer_offer;
                html += `
                    <div style="margin: 3rem 0; padding: 2rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%); border: 2px solid var(--accent-green); border-radius: 8px;">
                        <h3 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.4rem; font-weight: 700;">${toe.title}</h3>
                        <div class="info-box warning" style="margin-bottom: 1.5rem;">
                            <div class="info-box-title">Context</div>
                            <p>${toe.context}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                            <div class="info-box" style="background: rgba(46, 213, 115, 0.1);">
                                <div class="info-box-title">âœ… When to Use</div>
                                <ul class="bullet-list" style="margin-top: 0.5rem;">
                `;
                toe.when_to_use.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += `
                                </ul>
                            </div>
                            <div class="info-box" style="background: rgba(235, 77, 75, 0.1);">
                                <div class="info-box-title">âŒ When NOT to Use</div>
                                <ul class="bullet-list" style="margin-top: 0.5rem;">
                `;
                toe.when_NOT_to_use.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += `
                                </ul>
                            </div>
                        </div>

                        <div style="margin: 2rem 0;">
                            <h4 style="color: var(--accent-green); font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">${toe.the_logical_question.title}</h4>
                            <div class="info-box">
                                <div class="info-box-title">Setup</div>
                                <p>${toe.the_logical_question.setup}</p>
                            </div>
                            <div class="info-box" style="margin-top: 1rem;">
                                <div class="info-box-title">Framing</div>
                                <p>${toe.the_logical_question.framing}</p>
                            </div>
                            <div class="info-box advisor-note" style="margin-top: 1rem;">
                                <div class="info-box-title">ğŸ¯ The Positioning Script</div>
                                <div class="script-block" style="font-size: 1.05em; line-height: 1.7;">${formatScript(toe.the_logical_question.positioning_script)}</div>
                            </div>
                            <div class="info-box" style="margin-top: 1rem; background: rgba(46, 213, 115, 0.15);">
                                <div class="info-box-title">What You're Capturing</div>
                                <p style="font-weight: 600;">${toe.the_logical_question.what_youre_capturing}</p>
                            </div>
                        </div>

                        <div style="margin: 2rem 0;">
                            <h4 style="color: var(--text-primary); font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem;">${toe.the_trade_off_explanation.title}</h4>
                            <div class="info-box advisor-note">
                                <div class="info-box-title">Script</div>
                                <div class="script-block">${formatScript(toe.the_trade_off_explanation.script)}</div>
                            </div>
                            <div class="info-box" style="margin-top: 0.75rem;">
                                <div class="info-box-title">Goal</div>
                                <p>${toe.the_trade_off_explanation.goal}</p>
                            </div>
                        </div>

                        <div style="margin: 2rem 0;">
                            <h4 style="color: var(--text-primary); font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem;">${toe.encourage_self_realization.title}</h4>
                            <div class="info-box">
                                <div class="info-box-title">Principle</div>
                                <p>${toe.encourage_self_realization.principle}</p>
                            </div>
                            <div class="info-box advisor-note" style="margin-top: 1rem;">
                                <div class="info-box-title">${toe.encourage_self_realization.method}</div>
                                <ul class="bullet-list" style="margin-top: 0.75rem;">
                `;
                toe.encourage_self_realization.questions.forEach(q => {
                    html += `<li>${q}</li>`;
                });
                html += `
                                </ul>
                            </div>
                        </div>

                        <div style="margin: 2rem 0; padding: 1.5rem; background: rgba(46, 213, 115, 0.1); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                            <h4 style="color: var(--accent-green); font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">${toe.close_the_logical_chain.title}</h4>
                            <p style="margin-bottom: 1rem;">${toe.close_the_logical_chain.explanation}</p>
                            <div class="info-box" style="background: white;">
                                <div class="info-box-title">Sequence Complete âœ“</div>
                                <ul class="bullet-list" style="margin-top: 0.75rem;">
                `;
                toe.close_the_logical_chain.sequence_complete.forEach(step => {
                    html += `<li style="font-weight: 600;">${step}</li>`;
                });
                html += `
                                </ul>
                            </div>
                            <div class="info-box warning" style="margin-top: 1rem;">
                                <div class="info-box-title">What Happens Next</div>
                                <p style="font-weight: 600;">${toe.close_the_logical_chain.what_happens_next}</p>
                            </div>
                        </div>

                        <div class="info-box advisor-note" style="margin-top: 2rem;">
                            <div class="info-box-title">${toe.operator_posture.title}</div>
                            <ul class="bullet-list" style="margin-top: 0.75rem;">
                `;
                toe.operator_posture.points.forEach(point => {
                    html += `<li>${point}</li>`;
                });
                html += `
                            </ul>
                        </div>
                    </div>
                `;
            }

            // Recognize the Projection (for Quality Objection Handler)
            if (item.recognize_the_projection) {
                const proj = item.recognize_the_projection;
                html += `
                    <div class="info-box warning" style="margin: 1.5rem 0;">
                        <div class="info-box-title">${proj.title}</div>
                        <p><strong>Reality:</strong> ${proj.reality}</p>
                        <p style="margin-top: 0.5rem;"><strong>Interpretation:</strong> ${proj.interpretation}</p>
                    </div>
                `;
            }

            // Accountability Boundaries (for Quality Objection Handler)
            if (item.accountability_boundaries) {
                const acc = item.accountability_boundaries;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--primary-color); border-radius: 6px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${acc.title}</h3>
                        <div class="info-box">
                            <div class="info-box-title">Your Domain</div>
                            <p>${acc.your_domain}</p>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">Their Domain</div>
                            <p>${acc.their_domain}</p>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Positioning</div>
                            <p style="font-weight: 600;">${acc.positioning}</p>
                        </div>
                    </div>
                `;
            }

            // Redirect to Tic (for Quality Objection Handler)
            if (item.redirect_to_tic) {
                const tic = item.redirect_to_tic;
                html += `
                    <div style="margin: 1.5rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.2rem; font-weight: 700;">${tic.title}</h3>
                        <div class="info-box advisor-note">
                            <div class="info-box-title">Script</div>
                            <div class="script-block">${formatScript(tic.script)}</div>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">What This Does</div>
                            <p>${linkifyReferences(tic.what_this_does)}</p>
                        </div>
                    </div>
                `;
            }

            // Redirect to Tac (for Quality Objection Handler)
            if (item.redirect_to_tac) {
                const tac = item.redirect_to_tac;
                html += `
                    <div style="margin: 1.5rem 0;">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.2rem; font-weight: 700;">${tac.title}</h3>
                        <div class="info-box advisor-note">
                            <div class="info-box-title">Script</div>
                            <div class="script-block">${formatScript(tac.script)}</div>
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-box-title">What This Does</div>
                            <p>${linkifyReferences(tac.what_this_does)}</p>
                        </div>
                    </div>
                `;
            }

            // Mechanism Framing Reminder (for Quality Objection Handler)
            if (item.mechanism_framing_reminder) {
                const mech = item.mechanism_framing_reminder;
                html += `
                    <div class="info-box warning" style="margin: 1.5rem 0;">
                        <div class="info-box-title">${mech.title}</div>
                        <p><strong>Don't do:</strong> ${mech.dont_do}</p>
                        <p style="margin-top: 0.75rem;"><strong>Do instead:</strong> ${mech.do_instead}</p>
                        <div class="script-block" style="margin-top: 1rem;">${formatScript(mech.golden_line)}</div>
                    </div>
                `;
            }

            // QOA Preview (for Quality Objection Handler)
            if (item.qoa_preview) {
                const qoa = item.qoa_preview;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-yellow); border-radius: 6px;">
                        <h3 style="color: var(--accent-yellow); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${qoa.title}</h3>
                        <div class="info-box">
                            <div class="info-box-title">When to Use</div>
                            <p>${qoa.when_to_use}</p>
                        </div>
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Positioning</div>
                            <div class="script-block">${formatScript(qoa.positioning)}</div>
                        </div>
                        <div class="info-box warning" style="margin-top: 1rem;">
                            <div class="info-box-title">âš ï¸ Important</div>
                            <p>${qoa.important}</p>
                        </div>
                    </div>
                `;
            }

            // Required Outputs (removed - discovery_framework moved to references)
            if (item.required_outputs) {
                const ro = item.required_outputs;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--primary-color); border-radius: 6px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700;">${ro.title}</h3>
                        <div class="info-box warning" style="margin-bottom: 1.5rem;">
                            <div class="info-box-title">The Standard</div>
                            <p style="font-weight: 600; font-size: 1.05rem;">${ro.standard}</p>
                        </div>
                `;
                
                if (ro.artifacts && ro.artifacts.length > 0) {
                    ro.artifacts.forEach(artifact => {
                        html += `
                            <div style="margin-bottom: 2rem; padding: 1.25rem; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 6px;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                                    <div style="width: 40px; height: 40px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 700; margin-right: 1rem;">${artifact.number}</div>
                                    <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">${artifact.name}</h4>
                                </div>
                                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-style: italic;">${artifact.definition}</p>
                        `;
                        
                        if (artifact.standards && artifact.standards.length > 0) {
                            html += `
                                <div class="info-box" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Standards</div>
                                    <ul class="bullet-list">
                            `;
                            artifact.standards.forEach(standard => {
                                html += `<li>${standard}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                        
                        if (artifact.must_capture && artifact.must_capture.length > 0) {
                            html += `
                                <div class="info-box" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Must Capture</div>
                                    <ul class="bullet-list">
                            `;
                            artifact.must_capture.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                        
                        if (artifact.must_surface && artifact.must_surface.length > 0) {
                            html += `
                                <div class="info-box" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Must Surface</div>
                                    <ul class="bullet-list">
                            `;
                            artifact.must_surface.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                        
                        if (artifact.must_propose && artifact.must_propose.length > 0) {
                            html += `
                                <div class="info-box" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Must Propose</div>
                                    <ul class="bullet-list">
                            `;
                            artifact.must_propose.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                        
                        if (artifact.must_map && artifact.must_map.length > 0) {
                            html += `
                                <div class="info-box" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Must Map</div>
                                    <ul class="bullet-list">
                            `;
                            artifact.must_map.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                        
                        if (artifact.formula) {
                            html += `
                                <div class="info-box advisor-note" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Formula</div>
                                    <p style="font-weight: 600; font-family: monospace; background: var(--bg-secondary); padding: 0.75rem; border-radius: 4px;">${artifact.formula}</p>
                                </div>
                            `;
                        }
                        
                        if (artifact.example) {
                            html += `
                                <div class="info-box" style="margin-bottom: 1rem;">
                                    <div class="info-box-title">Example</div>
                                    <p>${artifact.example}</p>
                                </div>
                            `;
                        }
                        
                        if (artifact.fail_cues && artifact.fail_cues.length > 0) {
                            html += `
                                <div class="info-box warning" style="margin-top: 1rem;">
                                    <div class="info-box-title">âš ï¸ Fail Cues</div>
                                    <ul class="bullet-list">
                            `;
                            artifact.fail_cues.forEach(cue => {
                                html += `<li>${cue}</li>`;
                            });
                            html += `</ul></div>`;
                        }
                        
                        html += `</div>`;
                    });
                }
                html += `</div>`;
            }

            // Control Lines (for discovery_framework)
            if (item.control_lines) {
                const cl = item.control_lines;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                        <h3 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${cl.title}</h3>
                `;
                if (cl.lines && cl.lines.length > 0) {
                    cl.lines.forEach((line, idx) => {
                        html += `
                            <div class="script-block" style="margin-bottom: ${idx < cl.lines.length - 1 ? '1' : '0'}rem;">${formatScript(line)}</div>
                        `;
                    });
                }
                html += `</div>`;
            }

            // What Not To Do (for discovery_framework)
            if (item.what_not_to_do) {
                const wntd = item.what_not_to_do;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-red); border-radius: 6px;">
                        <h3 style="color: var(--accent-red); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${wntd.title}</h3>
                        <ul class="bullet-list">
                `;
                if (wntd.failures && wntd.failures.length > 0) {
                    wntd.failures.forEach((failure, idx) => {
                        html += `<li style="margin-bottom: 0.75rem; font-weight: 500;">${idx + 1}. ${failure}</li>`;
                    });
                }
                html += `</ul></div>`;
            }

            // QOA Deployment Guide specific sections
            if (item.when_to_deploy) {
                html += `
                    <div class="info-box" style="margin: 1.5rem 0; background: rgba(46, 213, 115, 0.1); border-left-color: var(--accent-green);">
                        <div class="info-box-title">${item.when_to_deploy.title}</div>
                        <ul class="bullet-list">
                `;
                item.when_to_deploy.criteria.forEach(criterion => {
                    html += `<li>${criterion}</li>`;
                });
                html += `</ul></div>`;
            }

            if (item.when_NOT_to_deploy) {
                html += `
                    <div class="info-box warning" style="margin: 1.5rem 0; background: rgba(235, 77, 75, 0.1); border-left-color: var(--accent-red);">
                        <div class="info-box-title">${item.when_NOT_to_deploy.title}</div>
                        <ul class="bullet-list">
                `;
                item.when_NOT_to_deploy.criteria.forEach(criterion => {
                    html += `<li>${criterion}</li>`;
                });
                html += `</ul></div>`;
            }

            if (item.on_call_sequence) {
                const seq = item.on_call_sequence;
                html += `
                    <div style="margin: 2rem 0; padding: 2rem; background: var(--bg-secondary); border: 2px solid var(--primary-color); border-radius: 12px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 2rem; font-size: 1.5rem; font-weight: 700;">${seq.title}</h3>
                `;

                // Tic
                if (seq.tic) {
                    const tic = seq.tic;
                    html += `
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.3rem; font-weight: 700;">Tic â†’ Get Process Repeatability Admission</h4>
                            <p style="margin-bottom: 1rem; font-style: italic; color: var(--text-secondary);"><strong>When:</strong> ${tic.when}</p>
                            <div class="script-block" style="margin-bottom: 1rem;">${formatScript(tic.script)}</div>
                            <p style="font-weight: 600; color: var(--accent-green);">${tic.outcome}</p>
                        </div>
                    `;
                }

                // Tac
                if (seq.tac) {
                    const tac = seq.tac;
                    html += `
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.3rem; font-weight: 700;">Tac â†’ Install A/B/C Definition</h4>
                            <p style="margin-bottom: 1rem; font-style: italic; color: var(--text-secondary);"><strong>When:</strong> ${tac.when}</p>
                            <div class="script-block" style="margin-bottom: 1rem;">${formatScript(tac.script)}</div>
                            <p style="font-weight: 600; color: var(--primary-color);">${tac.outcome}</p>
                        </div>
                    `;
                }

                // Toe (Optional)
                if (seq.toe_optional) {
                    const toe = seq.toe_optional;
                    html += `
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: var(--accent-yellow); margin-bottom: 1rem; font-size: 1.3rem; font-weight: 700;">Toe â†’ Offer Power Transfer (OPTIONAL)</h4>
                            <p style="margin-bottom: 1rem; font-style: italic; color: var(--text-secondary);"><strong>When:</strong> ${toe.when}</p>
                            <div class="script-block" style="margin-bottom: 1rem;">${formatScript(toe.script)}</div>
                            <p style="font-weight: 600; color: var(--accent-yellow);">${toe.outcome}</p>
                        </div>
                    `;
                }

                // Note
                if (seq.note) {
                    html += `
                        <div class="info-box warning" style="margin-top: 1rem;">
                            <div class="info-box-title">${seq.note}</div>
                        </div>
                    `;
                }

                html += `</div>`;
            }

            if (item.handling_quality_objections) {
                const qual = item.handling_quality_objections;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-red); border-radius: 6px;">
                        <h3 style="color: var(--accent-red); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${qual.title}</h3>
                        <p style="margin-bottom: 1rem;"><strong>Trigger:</strong> ${qual.trigger}</p>
                        <div class="info-box advisor-note">
                            <div class="info-box-title">Immediate Response</div>
                            <div class="script-block">${formatScript(qual.immediate_response)}</div>
                        </div>
                        <p style="margin-top: 1rem; font-style: italic; color: var(--text-secondary);"><strong>If they persist:</strong> ${qual.if_they_persist}</p>
                    </div>
                `;
            }

            if (item.quick_reference_card) {
                const qrc = item.quick_reference_card;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(37, 99, 235, 0.05) 100%); border: 2px solid var(--primary-color); border-radius: 8px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1.5rem; font-size: 1.3rem; font-weight: 700;">${qrc.title}</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="padding: 1rem; background: var(--bg-main); border-left: 3px solid var(--accent-green); border-radius: 4px;">
                                <p style="margin-bottom: 0.5rem; font-weight: 700; color: var(--accent-green);">Tic (Conceptual Yes)</p>
                                <p style="font-size: 0.95rem;">${qrc.tic}</p>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-main); border-left: 3px solid var(--primary-color); border-radius: 4px;">
                                <p style="margin-bottom: 0.5rem; font-weight: 700; color: var(--primary-color);">Tac (Directional Yes)</p>
                                <p style="font-size: 0.95rem;">${qrc.tac}</p>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-main); border-left: 3px solid var(--accent-yellow); border-radius: 4px;">
                                <p style="margin-bottom: 0.5rem; font-weight: 700; color: var(--accent-yellow);">Toe (Commitment Yes) â€” OPTIONAL</p>
                                <p style="font-size: 0.95rem;">${qrc.toe}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Where to Go Next
            if (item.where_to_go_next) {
                const wtgn = item.where_to_go_next;
                html += `
                    <div style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(37, 99, 235, 0.05) 100%); border-left: 4px solid var(--primary-color); border-radius: 6px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">ğŸ¯ ${wtgn.title}</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">${wtgn.guidance}</p>
                `;
                if (wtgn.options && wtgn.options.length > 0) {
                    html += `<div style="margin-bottom: 1.5rem;">`;
                    wtgn.options.forEach(option => {
                        html += `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 6px;">
                                <p style="margin-bottom: 0.5rem;"><strong style="color: var(--primary-color);">If:</strong> ${linkifyReferences(option.if)}</p>
                                <p><strong style="color: var(--accent-green);">Then:</strong> ${linkifyReferences(option.then)}</p>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                if (wtgn.default) {
                    html += `
                        <div class="info-box advisor-note" style="margin-top: 1rem;">
                            <div class="info-box-title">Default Path</div>
                            <p>${linkifyReferences(wtgn.default)}</p>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            // Advisor Notes
            if (item.advisor_notes && item.advisor_notes.length > 0) {
                html += `
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Advisor Notes</div>
                        <ul class="bullet-list">
                `;
                item.advisor_notes.forEach(note => {
                    html += `<li>${linkifyReferences(note)}</li>`;
                });
                html += `</ul></div>`;
                
                // Add link to full mastery course for referrals objection
                if (item.id === 'referrals_objection') {
                    html += `
                        <div class="info-box" style="margin-top: 1.5rem; border-left: 4px solid var(--primary-color);">
                            <div class="info-box-title">ğŸ“š For Deeper Mastery</div>
                            <p style="margin-bottom: 1rem;">This is a quick-reference guide for handling this objection during calls. For the complete mastery course with all modules, conversion audit framework, prevention strategies, and bottom-of-funnel reinforcement:</p>
                            <button onclick="loadReferenceContent('referrals_objection_mastery')" style="padding: 0.75rem 1.5rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-dark)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.3)';" onmouseout="this.style.background='var(--primary-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                Open Full Mastery Course â†’
                            </button>
                        </div>
                    `;
                }
            }

            // CARPET Integration
            if (item.carpet_integration) {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">CARPET Variables to Extract</div>
                        <p><strong>${item.carpet_integration.join(', ')}</strong></p>
                    </div>
                `;
            }

            // Navigation buttons for sequential flow
            const currentIndex = salesData.sequential_flow.call_one.findIndex(i => i.id === itemId);
            const prevItem = currentIndex > 0 ? salesData.sequential_flow.call_one[currentIndex - 1] : null;
            const nextItem = currentIndex < salesData.sequential_flow.call_one.length - 1 ? salesData.sequential_flow.call_one[currentIndex + 1] : null;

            html += `<div class="nav-buttons">`;
            if (prevItem) {
                html += `<button class="nav-btn nav-btn-prev" onclick="loadContent('${prevItem.id}', false)">â† Previous: ${prevItem.title.split('â€”')[0].trim()}</button>`;
            }
            if (nextItem) {
                html += `<button class="nav-btn nav-btn-next" onclick="loadContent('${nextItem.id}', true)">Next: ${nextItem.title.split('â€”')[0].trim()} â†’</button>`;
            }
            html += `</div>`;

            html += `</div>`;
            contentArea.innerHTML = html;
            
            // Scroll to top only if requested
            if (scrollToTop) {
                contentArea.scrollTop = 0;
            }
        }

        function loadReferenceContent(refId, updateURLParam = true) {
            const refData = salesData.reference_libraries[refId];
            if (!refData) return;

            // Update URL if requested
            if (updateURLParam) {
                updateURL('reference', refId);
            }

            // Update active state
            document.querySelectorAll('.nav-item, .nav-subitem').forEach(nav => nav.classList.remove('active'));
            const navItem = document.querySelector(`[data-id="${refId}"]`);
            if (navItem) navItem.classList.add('active');

            const contentArea = document.getElementById('content-area');
            let html = '';

            html += `
                <div class="content-header">
                    <span class="content-category reference">Reference Library</span>
                    <h2 class="content-title">${refData.title}</h2>
                    ${refData.purpose ? `<p class="content-purpose">${refData.purpose}</p>` : ''}
                    ${refData.subtitle ? `<p class="content-purpose">${refData.subtitle}</p>` : ''}
                </div>
                <div class="content-body">
            `;

            if (refId === 'two_economies') {
                html += `
                    <div class="two-column">
                        <div class="column-box">
                            <h4>Old Economy</h4>
                            <p><strong>Industries:</strong> ${refData.old_economy.industries}</p>
                            <p><strong>Values:</strong> ${refData.old_economy.values}</p>
                            <p><strong>Approach:</strong> ${refData.old_economy.approach}</p>
                        </div>
                        <div class="column-box">
                            <h4>New Economy</h4>
                            <p><strong>Industries:</strong> ${refData.new_economy.industries}</p>
                            <p><strong>Values:</strong> ${refData.new_economy.values}</p>
                            <p><strong>Approach:</strong> ${refData.new_economy.approach}</p>
                        </div>
                    </div>
                `;
            }

            if (refId === 'carpet_framework') {
                refData.variables.forEach(v => {
                    html += `
                        <div class="carpet-variable">
                            <div class="carpet-header">
                                <div class="carpet-letter">${v.letter}</div>
                                <div>
                                    <div class="carpet-name">${v.name}</div>
                                    <div class="carpet-description">${v.description}</div>
                                </div>
                            </div>
                            <div class="questions-list">
                    `;
                    v.questions.forEach((q, idx) => {
                        html += `<div class="script-block question-item">${idx + 1}. ${q}</div>`;
                    });
                    html += `</div></div>`;
                });
            }

            if (refId === 'active_listening') {
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Acknowledgment & Understanding</div>
                        <ul class="bullet-list">
                `;
                refData.acknowledgment.forEach(s => {
                    html += `<li>${s}</li>`;
                });
                html += `</ul></div>`;

                html += `
                    <div class="info-box">
                        <div class="info-box-title">Building Rapport</div>
                        <ul class="bullet-list">
                `;
                refData.building_rapport.forEach(s => {
                    html += `<li>${s}</li>`;
                });
                html += `</ul></div>`;

                html += `
                    <div class="info-box">
                        <div class="info-box-title">Transitioning to Discovery</div>
                        <ul class="bullet-list">
                `;
                refData.transitioning.forEach(s => {
                    html += `<li>${s}</li>`;
                });
                html += `</ul></div>`;
            }

            if (refId === 'discovery_framework') {
                // What Discovery Is
                if (refData.what_discovery_is) {
                    html += `
                        <div class="info-box advisor-note" style="margin: 1.5rem 0;">
                            <div class="info-box-title">What Discovery Is</div>
                            <p style="font-size: 1.05rem; line-height: 1.7; font-weight: 500;">${refData.what_discovery_is}</p>
                        </div>
                    `;
                }

                // Required Outputs
                if (refData.required_outputs) {
                    const ro = refData.required_outputs;
                    html += `
                        <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--primary-color); border-radius: 6px;">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700;">${ro.title}</h3>
                            <div class="info-box warning" style="margin-bottom: 1.5rem;">
                                <div class="info-box-title">The Standard</div>
                                <p style="font-weight: 600; font-size: 1.05rem;">${ro.standard}</p>
                            </div>
                    `;
                    
                    if (ro.artifacts && ro.artifacts.length > 0) {
                        ro.artifacts.forEach(artifact => {
                            html += `
                                <div style="margin-bottom: 2rem; padding: 1.25rem; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 6px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                                        <div style="width: 40px; height: 40px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 700; margin-right: 1rem;">${artifact.number}</div>
                                        <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">${artifact.name}</h4>
                                    </div>
                                    <p style="margin-bottom: 1rem; color: var(--text-secondary); font-style: italic;">${artifact.definition}</p>
                            `;
                            
                            if (artifact.standards && artifact.standards.length > 0) {
                                html += `
                                    <div class="info-box" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Standards</div>
                                        <ul class="bullet-list">
                                `;
                                artifact.standards.forEach(standard => {
                                    html += `<li>${standard}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (artifact.formula) {
                                html += `
                                    <div class="info-box advisor-note" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Formula</div>
                                        <p style="font-family: monospace; font-size: 0.95rem;">${artifact.formula}</p>
                                    </div>
                                `;
                            }

                            if (artifact.example) {
                                html += `
                                    <div class="info-box" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Example</div>
                                        <p>${artifact.example}</p>
                                    </div>
                                `;
                            }

                            if (artifact.must_capture && artifact.must_capture.length > 0) {
                                html += `
                                    <div class="info-box" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Must Capture</div>
                                        <ul class="bullet-list">
                                `;
                                artifact.must_capture.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (artifact.must_surface && artifact.must_surface.length > 0) {
                                html += `
                                    <div class="info-box" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Must Surface</div>
                                        <ul class="bullet-list">
                                `;
                                artifact.must_surface.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (artifact.must_propose && artifact.must_propose.length > 0) {
                                html += `
                                    <div class="info-box" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Must Propose</div>
                                        <ul class="bullet-list">
                                `;
                                artifact.must_propose.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (artifact.must_map && artifact.must_map.length > 0) {
                                html += `
                                    <div class="info-box" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Must Map</div>
                                        <ul class="bullet-list">
                                `;
                                artifact.must_map.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (artifact.fail_cues && artifact.fail_cues.length > 0) {
                                html += `
                                    <div class="info-box warning" style="margin-bottom: 1rem;">
                                        <div class="info-box-title">Fail Cues</div>
                                        <ul class="bullet-list">
                                `;
                                artifact.fail_cues.forEach(cue => {
                                    html += `<li>${cue}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            html += `</div>`;
                        });
                    }
                    html += `</div>`;
                }

                // Control Lines
                if (refData.control_lines) {
                    const cl = refData.control_lines;
                    html += `
                        <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-green); border-radius: 6px;">
                            <h3 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${cl.title}</h3>
                    `;
                    if (cl.lines && cl.lines.length > 0) {
                        cl.lines.forEach((line, idx) => {
                            html += `
                                <div class="script-block" style="margin-bottom: ${idx < cl.lines.length - 1 ? '1' : '0'}rem;">${formatScript(line)}</div>
                            `;
                        });
                    }
                    html += `</div>`;
                }

                // What Not To Do
                if (refData.what_not_to_do) {
                    const wntd = refData.what_not_to_do;
                    html += `
                        <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-secondary); border-left: 4px solid var(--accent-red); border-radius: 6px;">
                            <h3 style="color: var(--accent-red); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">${wntd.title}</h3>
                            <ul class="bullet-list">
                    `;
                    if (wntd.failures && wntd.failures.length > 0) {
                        wntd.failures.forEach((failure, idx) => {
                            html += `<li style="margin-bottom: 0.75rem; font-weight: 500;">${idx + 1}. ${failure}</li>`;
                        });
                    }
                    html += `</ul></div>`;
                }

                // Advisor Notes
                if (refData.advisor_notes && refData.advisor_notes.length > 0) {
                    html += `
                        <div class="info-box advisor-note">
                            <div class="info-box-title">Advisor Notes</div>
                            <ul class="bullet-list">
                    `;
                    refData.advisor_notes.forEach(note => {
                        html += `<li>${linkifyReferences(note)}</li>`;
                    });
                    html += `</ul></div>`;
                }
            }

            if (refId === 'qualified_opportunity_anchor_mastery' || refId === 'referrals_objection_mastery') {
                // Core truth and why it matters
                html += `
                    <div class="info-box">
                        <div class="info-box-title">Core Truth</div>
                        <p>${refData.core_truth}</p>
                    </div>
                    <div class="info-box advisor-note">
                        <div class="info-box-title">Why This Matters</div>
                        <p>${refData.why_this_matters}</p>
                    </div>
                `;

                // Render each module
                refData.modules.forEach(module => {
                    html += `
                        <div style="margin: 3rem 0;">
                            <h3 style="font-size: 1.75rem; color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color);">
                                Module ${module.number}: ${module.title}
                            </h3>
                    `;

                    if (module.subtitle) {
                        html += `<p style="font-style: italic; color: var(--text-secondary); margin-bottom: 1rem;">${module.subtitle}</p>`;
                    }

                    html += `
                        <div class="info-box advisor-note">
                            <div class="info-box-title">Key Insight</div>
                            <p>${module.key_insight}</p>
                        </div>
                    `;

                    // QOA-specific module content
                    if (module.when_to_deploy) {
                        html += `
                            <div class="info-box" style="background: rgba(46, 213, 115, 0.1);">
                                <div class="info-box-title">âœ… When to Deploy</div>
                                <ul class="bullet-list">
                        `;
                        module.when_to_deploy.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.when_NOT_to_deploy) {
                        html += `
                            <div class="info-box warning" style="background: rgba(235, 77, 75, 0.1);">
                                <div class="info-box-title">âŒ When NOT to Deploy</div>
                                <ul class="bullet-list">
                        `;
                        module.when_NOT_to_deploy.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.positive_signals) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">Positive Signals (Green Lights)</div>
                                <ul class="bullet-list">
                        `;
                        module.positive_signals.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.negative_signals) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">Negative Signals (Red Flags)</div>
                                <ul class="bullet-list">
                        `;
                        module.negative_signals.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.operational_flow) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">Operational Flow</div>
                                <ul class="bullet-list">
                        `;
                        module.operational_flow.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.required_infrastructure) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">Required Infrastructure</div>
                                <ul class="bullet-list">
                        `;
                        module.required_infrastructure.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.engagement_letter_clauses) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">Engagement Letter Clauses (Legal Reinforcement)</div>
                                <ul class="bullet-list">
                        `;
                        module.engagement_letter_clauses.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.re_entry_sequence) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">Re-Entry Sequence (5 Steps)</div>
                                <ul class="bullet-list">
                        `;
                        module.re_entry_sequence.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.what_to_avoid) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">âš ï¸ What to Avoid</div>
                                <ul class="bullet-list">
                        `;
                        module.what_to_avoid.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.re_entry_positioning) {
                        html += `
                            <div class="info-box advisor-note">
                                <div class="info-box-title">Re-Entry Positioning</div>
                                <p>${module.re_entry_positioning}</p>
                            </div>
                        `;
                    }

                    if (module.how_systems_interlock) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">How Systems Interlock</div>
                                <ul class="bullet-list">
                        `;
                        module.how_systems_interlock.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.operator_integration_workflow) {
                        html += `
                            <div class="info-box advisor-note">
                                <div class="info-box-title">Operator Integration Workflow</div>
                                <ul class="bullet-list">
                        `;
                        module.operator_integration_workflow.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    // Module-specific content
                    if (module.what_theyre_saying) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">What They're Really Saying</div>
                                <ul class="bullet-list">
                        `;
                        module.what_theyre_saying.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.belief_system) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">The Belief System You're Reframing</div>
                                <p>${module.belief_system}</p>
                            </div>
                        `;
                    }

                    if (module.green_flags) {
                        html += `
                            <div class="info-box advisor-note">
                                <div class="info-box-title">âœ… Green Flags â€” Signs of a Qualified Client</div>
                                <ul class="bullet-list">
                        `;
                        module.green_flags.forEach(flag => {
                            html += `<li>${flag}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.red_flags) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">ğŸš© Red Flags â€” Signs to Disqualify</div>
                                <ul class="bullet-list">
                        `;
                        module.red_flags.forEach(flag => {
                            html += `<li>${flag}</li>`;
                        });
                        html += `</ul>`;
                        if (module.red_flag_outcome) {
                            html += `<p style="margin-top: 1rem; font-weight: 600;">${module.red_flag_outcome}</p>`;
                        }
                        html += `</div>`;
                    }

                    if (module.disqualification_script) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">Polite Disqualification Script</div>
                                <div class="script-block">${formatScript(module.disqualification_script)}</div>
                            </div>
                        `;
                    }

                    if (module.why_disqualify) {
                        html += `
                            <div class="info-box advisor-note">
                                <div class="info-box-title">Why Disqualification is a Win</div>
                                <p>${module.why_disqualify}</p>
                            </div>
                        `;
                    }

                    // Render sections array if present
                    if (module.sections && module.sections.length > 0) {
                        module.sections.forEach(section => {
                            html += `
                                <div style="margin: 2rem 0;">
                                    <h4 style="font-size: 1.25rem; color: var(--text-primary); margin-bottom: 1rem;">${section.title}</h4>
                            `;

                            if (section.content) {
                                html += `<p style="margin-bottom: 1rem; line-height: 1.6;">${section.content}</p>`;
                            }

                            if (section.objective) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">Objective</div>
                                        <p style="font-weight: 600;">${section.objective}</p>
                                    </div>
                                `;
                            }

                            if (section.posture) {
                                html += `<p style="margin: 1rem 0;"><strong>Posture:</strong> ${section.posture}</p>`;
                            }

                            if (section.the_abc_framework) {
                                html += `
                                    <div class="info-box" style="margin: 1rem 0;">
                                        <div class="info-box-title">The A/B/C Framework</div>
                                        <ul class="bullet-list">
                                            <li><strong>A:</strong> ${section.the_abc_framework.A}</li>
                                            <li><strong>B:</strong> ${section.the_abc_framework.B}</li>
                                            <li><strong>C:</strong> ${section.the_abc_framework.C}</li>
                                        </ul>
                                    </div>
                                `;
                            }

                            if (section.deliberate_omission) {
                                html += `
                                    <div class="info-box warning">
                                        <div class="info-box-title">âš ï¸ Deliberate Omission</div>
                                        <p>${section.deliberate_omission}</p>
                                    </div>
                                `;
                            }

                            if (section.script) {
                                html += `
                                    <div class="script-block" style="margin: 1rem 0;">${formatScript(section.script)}</div>
                                `;
                            }

                            if (section.clarifying_titles) {
                                html += `<p style="margin: 1rem 0; font-style: italic;">${section.clarifying_titles}</p>`;
                            }

                            if (section.what_this_creates) {
                                html += `
                                    <div class="info-box advisor-note">
                                        <div class="info-box-title">What This Creates</div>
                                        <p>${section.what_this_creates}</p>
                                    </div>
                                `;
                            }

                            if (section.what_this_captures) {
                                html += `<p style="margin: 1rem 0; font-weight: 600;">${section.what_this_captures}</p>`;
                            }

                            if (section.how_to_execute && section.how_to_execute.length > 0) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">How to Execute</div>
                                        <ul class="bullet-list">
                                `;
                                section.how_to_execute.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.when_to_use && section.when_to_use.length > 0) {
                                html += `
                                    <div class="info-box" style="background: rgba(46, 213, 115, 0.1);">
                                        <div class="info-box-title">âœ… When to Use</div>
                                        <ul class="bullet-list">
                                `;
                                section.when_to_use.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.when_NOT_to_use && section.when_NOT_to_use.length > 0) {
                                html += `
                                    <div class="info-box warning" style="background: rgba(235, 77, 75, 0.1);">
                                        <div class="info-box-title">âŒ When NOT to Use</div>
                                        <ul class="bullet-list">
                                `;
                                section.when_NOT_to_use.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.the_positioning_script) {
                                html += `
                                    <div class="info-box advisor-note">
                                        <div class="info-box-title">The Positioning Script</div>
                                        <div class="script-block">${formatScript(section.the_positioning_script)}</div>
                                    </div>
                                `;
                            }

                            if (section.what_youre_capturing) {
                                html += `<p style="margin: 1rem 0; font-weight: 600; color: var(--accent-green);">âœ“ ${section.what_youre_capturing}</p>`;
                            }

                            if (section.the_trade_off) {
                                html += `<p style="margin: 1rem 0; font-style: italic;">${section.the_trade_off}</p>`;
                            }

                            if (section.critical_note) {
                                html += `
                                    <div class="info-box warning" style="margin: 1rem 0;">
                                        <div class="info-box-title">âš ï¸ Critical Note</div>
                                        <p>${section.critical_note}</p>
                                    </div>
                                `;
                            }

                            if (section.advisor_notes && section.advisor_notes.length > 0) {
                                html += `
                                    <div class="info-box advisor-note">
                                        <div class="info-box-title">Advisor Notes</div>
                                        <ul class="bullet-list">
                                `;
                                section.advisor_notes.forEach(note => {
                                    html += `<li>${linkifyReferences(note)}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.right_approach) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">The Right Approach</div>
                                        <ul class="bullet-list">
                                `;
                                section.right_approach.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.diagnostic_questions) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">Diagnostic Questions</div>
                                        <ul class="bullet-list">
                                `;
                                section.diagnostic_questions.forEach(q => {
                                    html += `<li>${q}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.outcome) {
                                html += `<p style="margin: 1rem 0; font-style: italic;">${section.outcome}</p>`;
                            }

                            if (section.golden_rule) {
                                html += `
                                    <div class="info-box warning">
                                        <div class="info-box-title">Golden Rule</div>
                                        <p>${section.golden_rule}</p>
                                    </div>
                                `;
                            }

                            if (section.formula) {
                                html += `<p style="font-weight: 600; margin: 1rem 0; color: var(--primary-color);">${section.formula}</p>`;
                            }

                            if (section.example_exchange) {
                                html += `
                                    <div class="two-column" style="margin: 1.5rem 0;">
                                        <div class="column-box">
                                            <h4>Prospect</h4>
                                            <p>"${section.example_exchange.prospect}"</p>
                                        </div>
                                        <div class="column-box">
                                            <h4>You</h4>
                                            <p>"${section.example_exchange.you}"</p>
                                        </div>
                                    </div>
                                `;
                            }

                            if (section.what_happened) {
                                html += `
                                    <div class="info-box advisor-note">
                                        <div class="info-box-title">What Just Happened</div>
                                        <ul class="bullet-list">
                                `;
                                section.what_happened.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.principle) {
                                html += `<p style="margin: 1rem 0; font-weight: 600;">${section.principle}</p>`;
                            }

                            if (section.examples) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">Examples</div>
                                        <ul class="bullet-list">
                                `;
                                section.examples.forEach(ex => {
                                    html += `<li>${ex}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.technique) {
                                html += `<p style="margin: 1rem 0; font-style: italic;">${section.technique}</p>`;
                            }

                            if (section.shift) {
                                html += `<p style="margin: 1rem 0; font-weight: 600; color: var(--primary-color);">The Shift: ${section.shift}</p>`;
                            }

                            if (section.audit_questions) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">Audit Questions</div>
                                        <ul class="bullet-list">
                                `;
                                section.audit_questions.forEach(q => {
                                    html += `<li>${q}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.goal) {
                                html += `<p style="margin: 1rem 0; font-style: italic; color: var(--text-secondary);">${section.goal}</p>`;
                            }

                            if (section.path_1) {
                                html += `
                                    <div class="two-column" style="margin: 1.5rem 0;">
                                        <div class="column-box">
                                            <h4>Path 1: ${section.path_1.condition}</h4>
                                            <p style="font-style: italic; margin-top: 1rem;">"${section.path_1.frame}"</p>
                                        </div>
                                `;
                            }

                            if (section.path_2) {
                                html += `
                                        <div class="column-box">
                                            <h4>Path 2: ${section.path_2.condition}</h4>
                                            <p style="margin-bottom: 0.5rem;"><strong>Technique:</strong> ${section.path_2.technique}</p>
                                            <ul class="bullet-list">
                                `;
                                section.path_2.steps.forEach(step => {
                                    html += `<li>${step}</li>`;
                                });
                                html += `</ul>`;
                                if (section.path_2.power) {
                                    html += `<p style="margin-top: 1rem; font-style: italic; font-weight: 600;">${section.path_2.power}</p>`;
                                }
                                html += `
                                        </div>
                                    </div>
                                `;
                            }

                            if (section.example) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">Example</div>
                                        <ul class="bullet-list">
                                `;
                                section.example.forEach(ex => {
                                    html += `<li>${ex}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.protection) {
                                html += `
                                    <div class="info-box advisor-note">
                                        <div class="info-box-title">How This Protects You</div>
                                        <p>${section.protection}</p>
                                    </div>
                                `;
                            }

                            if (section.framework) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">The Framework</div>
                                        <ul class="bullet-list">
                                `;
                                section.framework.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.reframe) {
                                html += `<p style="margin: 1rem 0; font-style: italic; color: var(--primary-color);">${section.reframe}</p>`;
                            }

                            if (section.warning) {
                                html += `
                                    <div class="info-box warning">
                                        <div class="info-box-title">âš ï¸ Warning</div>
                                        <p>${section.warning}</p>
                                    </div>
                                `;
                            }

                            if (section.script) {
                                html += `
                                    <div class="script-block">${formatScript(section.script)}</div>
                                `;
                            }

                            if (section.benefit) {
                                html += `<p style="margin: 1rem 0; font-weight: 600; color: var(--accent-green);">âœ“ ${section.benefit}</p>`;
                            }

                            if (section.truth) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">The Truth</div>
                                        <ul class="bullet-list">
                                `;
                                section.truth.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.structure) {
                                html += `
                                    <div class="info-box">
                                        <div class="info-box-title">One-Liner Structure</div>
                                        <ul class="bullet-list">
                                `;
                                section.structure.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.note) {
                                html += `<p style="margin: 1rem 0; font-style: italic; color: var(--text-secondary);">${section.note}</p>`;
                            }

                            if (section.progression) {
                                html += `
                                    <div class="info-box advisor-note">
                                        <div class="info-box-title">The Progression</div>
                                        <ul class="bullet-list">
                                `;
                                section.progression.forEach(item => {
                                    html += `<li>${item}</li>`;
                                });
                                html += `</ul></div>`;
                            }

                            if (section.real_prevention) {
                                html += `<p style="margin: 1rem 0; font-weight: 600; color: var(--accent-green);">${section.real_prevention}</p>`;
                            }

                            html += `</div>`;
                        });
                    }

                    if (module.closing_summary) {
                        html += `
                            <div class="script-block" style="margin-top: 2rem;">${formatScript(module.closing_summary)}</div>
                        `;
                    }

                    if (module.what_this_does) {
                        html += `
                            <div class="info-box advisor-note">
                                <div class="info-box-title">What This Does</div>
                                <ul class="bullet-list">
                        `;
                        module.what_this_does.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.why_it_resurfaces) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">Why It Resurfaces Late</div>
                                <ul class="bullet-list">
                        `;
                        module.why_it_resurfaces.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.late_stage_playbook) {
                        html += `
                            <div class="info-box">
                                <div class="info-box-title">Late-Stage Playbook</div>
                                <ul class="bullet-list">
                        `;
                        module.late_stage_playbook.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += `</ul></div>`;
                    }

                    if (module.critical_point) {
                        html += `<p style="margin: 1rem 0; font-weight: 600; color: var(--primary-color);">${module.critical_point}</p>`;
                    }

                    if (module.warning) {
                        html += `
                            <div class="info-box warning">
                                <div class="info-box-title">âš ï¸ Critical Warning</div>
                                <p>${module.warning}</p>
                            </div>
                        `;
                    }

                    if (module.remember) {
                        html += `<p style="margin: 1rem 0; font-weight: 600; font-style: italic;">${module.remember}</p>`;
                    }

                    html += `</div>`;
                });

                // Core takeaways
                html += `
                    <div style="margin: 3rem 0; padding: 2rem; background: var(--bg-secondary); border-radius: 8px; border: 2px solid var(--primary-color);">
                        <h3 style="font-size: 1.5rem; color: var(--primary-color); margin-bottom: 1.5rem;">Core Takeaways</h3>
                        <ul class="bullet-list">
                `;
                refData.core_takeaways.forEach(takeaway => {
                    html += `<li style="margin-bottom: 1rem; font-weight: 500;">${takeaway}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;

                // Final word
                html += `
                    <div class="info-box advisor-note" style="margin-top: 2rem;">
                        <div class="info-box-title">Final Word</div>
                        <p style="font-size: 1.05rem; line-height: 1.8;">${refData.final_word}</p>
                    </div>
                `;
            }

            html += `</div>`;
            contentArea.innerHTML = html;
            contentArea.scrollTop = 0;
        }

        // Helper function to add clickable links to cross-references
        function linkifyReferences(text) {
            if (!text) return '';
            
            // Map of reference patterns to their item IDs and display names
            const referenceMap = [
                // Sequential flow items
                { pattern: /\b(engagement model|Engagement Model|the engagement model)\b/gi, 
                  itemId: 'discovery_framework', 
                  text: 'Engagement Model' },
                { pattern: /\b(The 'Tic'|the 'Tic'|Tic admission|process repeatability)\b/gi, 
                  itemId: 'discovery_bottom_funnel', 
                  text: "The 'Tic' â€” Process Repeatability" },
                { pattern: /\b(The 'Tac'|the 'Tac'|Tac|A\/B\/C framework|A\/B\/C standard)\b/gi, 
                  itemId: 'defining_qualified_opportunities', 
                  text: "The 'Tac' â€” Defining Qualified Opportunities" },
                { pattern: /\b(The 'Toe'|the 'Toe'|Toe|power transfer)\b/gi, 
                  itemId: 'the_toe_power_transfer', 
                  text: "The 'Toe' â€” Power Transfer" },
                { pattern: /\b(Tic-Tac-Toe|Tic-Tac-Toeâ„¢)\b/gi, 
                  itemId: 'defining_qualified_opportunities', 
                  text: 'Tic-Tac-Toeâ„¢ Sequence' },
                { pattern: /\b(QOA|QOAâ„¢|Qualified Opportunity Anchor)\b/gi, 
                  itemId: 'the_toe_power_transfer', 
                  text: 'QOAâ„¢' },
                { pattern: /\b(CARPET|CARPET Framework)\b/gi, 
                  itemId: 'carpet_framework', 
                  isReference: true, 
                  text: 'CARPET Framework' },
                { pattern: /\b(discovery framework|Discovery Framework)\b/gi, 
                  itemId: 'discovery_framework', 
                  text: 'Discovery Framework' },
                { pattern: /\b(bottom of funnel|Bottom of Funnel)\b/gi, 
                  itemId: 'discovery_bottom_funnel', 
                  text: 'Bottom of Funnel' },
                { pattern: /\b(universal objection|Universal Objection Handle)\b/gi, 
                  itemId: 'universal_objection_handle', 
                  text: 'Universal Objection Handle' },
                { pattern: /\b(referrals objection|Referrals Objection)\b/gi, 
                  itemId: 'referrals_objection_mastery', 
                  isReference: true, 
                  text: 'Referrals Objection Mastery' },
                { pattern: /\b(QOA Mastery|QOA Training|Qualified Opportunity Anchor Mastery)\b/gi, 
                  itemId: 'qualified_opportunity_anchor_mastery', 
                  isReference: true, 
                  text: 'QOAâ„¢ Complete Training Guide' }
            ];
            
            let linkedText = text;
            
            // Handle objection number references like "objection #5" or "objection 5"
            linkedText = linkedText.replace(/\b(objection\s*#?(\d+)|objection\s+number\s+(\d+))\b/gi, (match, p1, num1, num2) => {
                const objectionNum = parseInt(num1 || num2);
                if (objectionNum >= 1 && objectionNum <= 17) {
                    return `<a href="#" onclick="loadObjection(${objectionNum}); return false;" style="color: var(--primary-color); text-decoration: underline; cursor: pointer; font-weight: 600;">${match}</a>`;
                }
                return match;
            });
            
            // Handle other references - skip if text already contains HTML links to avoid double-processing
            if (!linkedText.includes('<a href="#" onclick="')) {
                referenceMap.forEach(ref => {
                    linkedText = linkedText.replace(ref.pattern, (match) => {
                        const handler = ref.isReference ? 'loadReferenceContent' : 'loadContent';
                        const escapedItemId = ref.itemId.replace(/'/g, "\\'");
                        return `<a href="#" onclick="${handler}('${escapedItemId}'); return false;" style="color: var(--primary-color); text-decoration: underline; cursor: pointer; font-weight: 600;" title="Click to view ${ref.text.replace(/"/g, '&quot;')}">${match}</a>`;
                    });
                });
            }
            
            return linkedText;
        }

        function formatScript(scriptText) {
            if (!scriptText) return '';
            
            // Split into paragraphs
            let formatted = scriptText
                // Replace parenthetical pauses/notes with styled spans
                .replace(/\(([^)]+)\)/g, '<span class="script-pause">($1)</span>')
                // Split by double newlines for paragraphs
                .split('\n\n')
                .map(para => {
                    // Trim the paragraph
                    para = para.trim();
                    if (!para) return '';
                    
                    // Wrap questions with emphasis
                    if (para.includes('?')) {
                        para = para.replace(/([^.!?]*\?)/g, '<span class="script-question">$1</span>');
                    }
                    
                    return `<span class="script-paragraph">${para}</span>`;
                })
                .filter(p => p)
                .join('');
            
            return formatted;
        }

        function showEconomyPath(itemId, pathId) {
            const item = salesData.sequential_flow.call_one.find(i => i.id === itemId);
            if (!item || !item.paths) return;
            
            const path = item.paths.find(p => p.id === pathId);
            if (!path) return;

            const displayArea = document.getElementById('economy-script-display');
            displayArea.innerHTML = `
                <div class="info-box" style="margin-top: 2rem;">
                    <div class="info-box-title">${path.economy}</div>
                    <p><em>${path.context}</em></p>
                    <div class="script-block">${formatScript(path.script)}</div>
                </div>
            `;
        }

        // Theme management
        const themes = {
            // Ocean Themes - Calming blue tones
            'ocean-light': {
                'ui-theme': 'ocean',
                'layout-mode': 'executive-presentation',
                'primary-color': '#2563eb',
                'primary-dark': '#1d4ed8',
                'bg-main': '#ffffff',
                'bg-secondary': '#eff6ff',
                'bg-sidebar': '#1e40af',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#93c5fd',
                'border-color': '#bfdbfe',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#dbeafe',
                'script-text': '#0f172a',
                'quote-color': '#2563eb',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'ocean-dark': {
                'ui-theme': 'ocean',
                'layout-mode': 'executive-presentation',
                'primary-color': '#60a5fa',
                'primary-dark': '#3b82f6',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#60a5fa',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Forest Themes - Soothing green tones
            'forest-light': {
                'ui-theme': 'forest',
                'layout-mode': 'executive-presentation',
                'primary-color': '#059669',
                'primary-dark': '#047857',
                'bg-main': '#ffffff',
                'bg-secondary': '#ecfdf5',
                'bg-sidebar': '#065f46',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#6ee7b7',
                'border-color': '#a7f3d0',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#d1fae5',
                'script-text': '#0f172a',
                'quote-color': '#059669',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'forest-dark': {
                'ui-theme': 'forest',
                'layout-mode': 'executive-presentation',
                'primary-color': '#34d399',
                'primary-dark': '#10b981',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#34d399',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Sunset Themes - Warm orange/red tones
            'sunset-light': {
                'ui-theme': 'sunset',
                'layout-mode': 'executive-presentation',
                'primary-color': '#dc2626',
                'primary-dark': '#b91c1c',
                'bg-main': '#ffffff',
                'bg-secondary': '#fef2f2',
                'bg-sidebar': '#991b1b',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#fca5a5',
                'border-color': '#fecaca',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#fee2e2',
                'script-text': '#0f172a',
                'quote-color': '#dc2626',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'sunset-dark': {
                'ui-theme': 'sunset',
                'layout-mode': 'executive-presentation',
                'primary-color': '#f87171',
                'primary-dark': '#ef4444',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#f87171',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Lavender Themes - Soft purple tones
            'lavender-light': {
                'ui-theme': 'lavender',
                'layout-mode': 'executive-presentation',
                'primary-color': '#7c3aed',
                'primary-dark': '#6d28d9',
                'bg-main': '#ffffff',
                'bg-secondary': '#faf5ff',
                'bg-sidebar': '#581c87',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#c4b5fd',
                'border-color': '#ddd6fe',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#ede9fe',
                'script-text': '#0f172a',
                'quote-color': '#7c3aed',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'lavender-dark': {
                'ui-theme': 'lavender',
                'layout-mode': 'executive-presentation',
                'primary-color': '#a78bfa',
                'primary-dark': '#8b5cf6',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#a78bfa',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Neutral Themes - Gray/brown tones
            'neutral-light': {
                'ui-theme': 'neutral',
                'layout-mode': 'executive-presentation',
                'primary-color': '#4b5563',
                'primary-dark': '#374151',
                'bg-main': '#ffffff',
                'bg-secondary': '#f9fafb',
                'bg-sidebar': '#1f2937',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#9ca3af',
                'border-color': '#d1d5db',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#f3f4f6',
                'script-text': '#0f172a',
                'quote-color': '#4b5563',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'neutral-dark': {
                'ui-theme': 'neutral',
                'layout-mode': 'executive-presentation',
                'primary-color': '#9ca3af',
                'primary-dark': '#6b7280',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#9ca3af',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Rose Themes - Soft pink tones
            'rose-light': {
                'ui-theme': 'rose',
                'layout-mode': 'executive-presentation',
                'primary-color': '#be185d',
                'primary-dark': '#9d174d',
                'bg-main': '#ffffff',
                'bg-secondary': '#fdf2f8',
                'bg-sidebar': '#831843',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#f9a8d4',
                'border-color': '#fbcfe8',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#fce7f3',
                'script-text': '#0f172a',
                'quote-color': '#be185d',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'rose-dark': {
                'ui-theme': 'rose',
                'layout-mode': 'executive-presentation',
                'primary-color': '#f472b6',
                'primary-dark': '#ec4899',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#f472b6',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Sage Themes - Muted green tones
            'sage-light': {
                'ui-theme': 'sage',
                'layout-mode': 'executive-presentation',
                'primary-color': '#16a34a',
                'primary-dark': '#15803d',
                'bg-main': '#ffffff',
                'bg-secondary': '#f0fdf4',
                'bg-sidebar': '#14532d',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#86efac',
                'border-color': '#bbf7d0',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#dcfce7',
                'script-text': '#0f172a',
                'quote-color': '#16a34a',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'sage-dark': {
                'ui-theme': 'sage',
                'layout-mode': 'executive-presentation',
                'primary-color': '#4ade80',
                'primary-dark': '#22c55e',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#4ade80',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Sky Themes - Light blue tones
            'sky-light': {
                'ui-theme': 'sky',
                'layout-mode': 'executive-presentation',
                'primary-color': '#0284c7',
                'primary-dark': '#0369a1',
                'bg-main': '#ffffff',
                'bg-secondary': '#f0f9ff',
                'bg-sidebar': '#0c4a6e',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#7dd3fc',
                'border-color': '#bae6fd',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#e0f2fe',
                'script-text': '#0f172a',
                'quote-color': '#0284c7',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'sky-dark': {
                'ui-theme': 'sky',
                'layout-mode': 'executive-presentation',
                'primary-color': '#38bdf8',
                'primary-dark': '#0ea5e9',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#38bdf8',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            // Original Presentation themes (keeping for compatibility)
            'presentation-light': {
                'ui-theme': 'presentation',
                'layout-mode': 'executive-presentation',
                'primary-color': '#1e40af',
                'primary-dark': '#1e3a8a',
                'bg-main': '#ffffff',
                'bg-secondary': '#eff6ff',
                'bg-sidebar': '#1e3a8a',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#93c5fd',
                'border-color': '#bfdbfe',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#dbeafe',
                'script-text': '#0f172a',
                'quote-color': '#1e40af',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },
            'orange-light': {
                'ui-theme': 'orange',
                'layout-mode': 'executive-presentation',
                'primary-color': '#f97316',
                'primary-dark': '#ea580c',
                'bg-main': '#ffffff',
                'bg-secondary': '#fff7ed',
                'bg-sidebar': '#9a3412',
                'text-primary': '#0f172a',
                'text-secondary': '#1e293b',
                'text-light': '#fed7aa',
                'border-color': '#fed7aa',
                'accent-green': '#059669',
                'accent-yellow': '#d97706',
                'accent-red': '#b91c1c',
                'script-bg': '#fef3c7',
                'script-text': '#0f172a',
                'quote-color': '#f97316',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            'orange-dark': {
                'ui-theme': 'orange',
                'layout-mode': 'executive-presentation',
                'primary-color': '#fb923c',
                'primary-dark': '#f97316',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#fb923c',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            },

            'presentation-dark': {
                'ui-theme': 'presentation',
                'layout-mode': 'executive-presentation',
                'primary-color': '#3b82f6',
                'primary-dark': '#2563eb',
                'bg-main': '#0f172a',
                'bg-secondary': '#1e293b',
                'bg-sidebar': '#0f172a',
                'text-primary': '#f1f5f9',
                'text-secondary': '#cbd5e1',
                'text-light': '#64748b',
                'border-color': '#334155',
                'accent-green': '#10b981',
                'accent-yellow': '#f59e0b',
                'accent-red': '#ef4444',
                'script-bg': '#1e293b',
                'script-text': '#f1f5f9',
                'quote-color': '#3b82f6',
                'script-font-family': '"Merriweather", serif',
                'script-font-size': '18px'
            }
        };

        let currentTheme = localStorage.getItem('theme') || 'presentation-light';
        let currentUITheme = localStorage.getItem('ui-theme') || 'presentation';

        function setTheme(theme) {
            const root = document.documentElement;
            const body = document.body;
            const themeColors = themes[theme];

            if (!themeColors) {
                console.warn(`Theme '${theme}' not found, falling back to presentation-light`);
                return setTheme('presentation-light');
            }

            // Apply theme colors
            for (const [property, value] of Object.entries(themeColors)) {
                root.style.setProperty(`--${property}`, value);
            }

            // Update UI theme classes
            const uiTheme = themeColors['ui-theme'];
            const layoutMode = themeColors['layout-mode'];

            // Remove all existing theme classes
            body.className = body.className.replace(/\bui-theme-\w+\b/g, '').replace(/\blayout-\w+[-\w]*\b/g, '').trim();

            // Add new theme classes
            body.classList.add(`ui-theme-${uiTheme}`);
            body.classList.add(`layout-${layoutMode.replace(/-/g, '-')}`);

            // Handle dark mode styling for sidebar
            const isDark = theme.includes('-dark') || theme === 'dark';
            if (isDark) {
                root.style.setProperty('--sidebar-text', '#f1f5f9');
                root.style.setProperty('--sidebar-border', 'rgba(241, 245, 249, 0.1)');
                body.classList.add('dark-mode');
            } else {
                root.style.setProperty('--sidebar-text', '#cbd5e1');
                root.style.setProperty('--sidebar-border', 'rgba(255, 255, 255, 0.1)');
                body.classList.remove('dark-mode');
            }

            localStorage.setItem('theme', theme);
            localStorage.setItem('ui-theme', uiTheme);
            currentTheme = theme;
            currentUITheme = uiTheme;

            // Update theme selector
            updateThemeSelector();

        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // Settings popup functionality
        const settingsPopup = document.getElementById('settings-popup');
        const settingsFab = document.getElementById('settings-fab');
        const themeSelect = document.getElementById('theme-select');
        const fontDecrease = document.getElementById('font-decrease');
        const fontIncrease = document.getElementById('font-increase');
        const sizeDecrease = document.getElementById('size-decrease');
        const sizeIncrease = document.getElementById('size-increase');
        const fontSizeValue = document.getElementById('font-size-value');

        // Initialize font size from localStorage or default to 16px
        const savedFontSize = localStorage.getItem('scriptFontSize') || '16';
        document.documentElement.style.setProperty('--script-font-size', savedFontSize + 'px');
        fontSizeValue.textContent = savedFontSize + 'px';

        // Show/hide settings popup
        function toggleSettings() {
            const isShowing = settingsPopup.classList.toggle('show');
            settingsFab.classList.toggle('active', isShowing);
        }

        settingsFab.addEventListener('click', toggleSettings);

        // Advice toggle functionality
        const adviceToggleFab = document.getElementById('advice-toggle-fab');
        
        // Initialize advice visibility from localStorage (default: visible)
        const adviceVisible = localStorage.getItem('adviceVisible') !== 'false';
        if (!adviceVisible) {
            document.body.classList.add('advice-hidden');
            adviceToggleFab.classList.add('hidden');
        }

        function toggleAdvice() {
            const isHidden = document.body.classList.toggle('advice-hidden');
            adviceToggleFab.classList.toggle('hidden', isHidden);
            localStorage.setItem('adviceVisible', !isHidden);
        }

        adviceToggleFab.addEventListener('click', toggleAdvice);

        // Theme selector handler
        themeSelect.addEventListener('change', (e) => {
            setTheme(e.target.value);
        });

        // Initialize theme selector
        function updateThemeSelector() {
            if (themeSelect) {
                themeSelect.value = currentTheme;
            }
        }

        // Initialize theme on page load
        setTheme(currentTheme);
        updateThemeSelector();

        // Font size controls
        function updateFontSize(fontSize) {
            document.documentElement.style.setProperty('--script-font-size', fontSize + 'px');
            fontSizeValue.textContent = fontSize + 'px';
            localStorage.setItem('scriptFontSize', fontSize);
        }

        sizeDecrease.addEventListener('click', function() {
            const currentSize = parseInt(fontSizeValue.textContent);
            if (currentSize > 12) {
                updateFontSize(currentSize - 1);
            }
        });

        sizeIncrease.addEventListener('click', function() {
            const currentSize = parseInt(fontSizeValue.textContent);
            if (currentSize < 24) {
                updateFontSize(currentSize + 1);
            }
        });

        // Font management
        const fontOptions = {
            'Inter': '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", sans-serif',
            'Open Sans': '"Open Sans", sans-serif',
            'Roboto': '"Roboto", sans-serif',
            'Lato': '"Lato", sans-serif',
            'Merriweather': '"Merriweather", serif',
            'Spectral': '"Spectral", serif',
            'Atkinson Hyperlegible': '"Atkinson Hyperlegible", sans-serif'
        };

        function setFont(fontName) {
            const root = document.documentElement;
            const fontFamily = fontOptions[fontName];
            root.style.setProperty('--script-font-family', fontFamily);
            localStorage.setItem('selectedFont', fontName);

            // Update select element
            const select = document.getElementById('font-select');
            if (select) select.value = fontName;
        }

        // Initialize font from localStorage or default to Merriweather
        const savedFont = localStorage.getItem('selectedFont') || 'Merriweather';
        setFont(savedFont);

        // Add font selector event listener
        document.getElementById('font-select').addEventListener('change', function(e) {
            setFont(e.target.value);
        });

        // Initialize app after all scripts are loaded
        buildNavigation();
        buildReferenceNavigation();
        buildHandlerNavigation();
        handleRoute();
    </script>
</body>
</html>

